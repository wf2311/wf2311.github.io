<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>王峰的博客</title>
  <icon>https://www.gravatar.com/avatar/f12acb240e0a43c7f35ca20b62c0439d</icon>
  <subtitle>保持学习</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://www.wangfeng.pro/"/>
  <updated>2021-05-25T02:36:24.186Z</updated>
  <id>https://www.wangfeng.pro/</id>
  
  <author>
    <name>王峰</name>
    <email>work@wangfeng.pro</email>
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SpringCloud中使用Apollo实现动态刷新</title>
    <link href="https://www.wangfeng.pro/2021/05/springcloud%E4%B8%AD%E4%BD%BF%E7%94%A8apollo%E5%AE%9E%E7%8E%B0%E5%8A%A8%E6%80%81%E5%88%B7%E6%96%B0.html"/>
    <id>https://www.wangfeng.pro/2021/05/springcloud中使用apollo实现动态刷新.html</id>
    <published>2021-05-17T12:14:24.000Z</published>
    <updated>2021-05-25T02:36:24.186Z</updated>
    
    <content type="html"><![CDATA[<h1 id="普通字段"><a href="#普通字段" class="headerlink" title="普通字段"></a>普通字段</h1><p>在需要刷新的字段上使用<code>@value</code>注解即可，例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Value(&quot;$&#123;test.user.name&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;test.user.age&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value(&quot;$&#123;test.user.sex&#125;&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Boolean sex;</span><br></pre></td></tr></table></figure><span id="more"></span><h1 id="bean使用-ConfigurationProperties动态刷新"><a href="#bean使用-ConfigurationProperties动态刷新" class="headerlink" title="bean使用@ConfigurationProperties动态刷新"></a>bean使用@ConfigurationProperties动态刷新</h1><p>bean使用@ConfigurationProperties注解目前还不支持自动刷新，得编写一定的代码实现刷新。目前官方提供2种刷新方案：</p><ul><li>基于RefreshScope实现刷新</li><li>基于EnvironmentChangeEvent实现刷新</li></ul><h2 id="方法一：基于RefreshScope实现刷新"><a href="#方法一：基于RefreshScope实现刷新" class="headerlink" title="方法一：基于RefreshScope实现刷新"></a>方法一：基于RefreshScope实现刷新</h2><ol><li>确保项目中已引入依赖</li></ol><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ol start="2"><li>实体类上使用<code>@RefreshScope</code>注解</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(&quot;test.user&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestUserProperties</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Boolean sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在namespace=config的命名空间中定义配置：</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">test.user.name</span> = <span class="string">zhangsan</span></span><br><span class="line"><span class="meta">test.user.age</span> = <span class="string">10</span></span><br><span class="line"><span class="meta">test.user.sex</span> = <span class="string">1</span></span><br></pre></td></tr></table></figure><ol start="3"><li>利用RefreshScope搭配@ApolloConfigChangeListener监听实现bean的动态刷新</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApolloDynamicConfigPropertiesRefresh</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    RefreshScope refreshScope;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApolloConfigChangeListener(value=&quot;config&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">(ConfigChangeEvent changeEvent)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        refreshScope.refresh(<span class="string">&quot;testUserProperties&quot;</span>);</span><br><span class="line"></span><br><span class="line">        PrintChangeKeyUtils.printChange(changeEvent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>@ApolloConfigChangeListener(value=&quot;config&quot;)</code> 表示监听namespace=config的配置文件的变化</li><li><code>refreshScope.refresh(&quot;testUserProperties&quot;);</code> 表示如果触发监听事件，则刷新名为<code>testUserProperties</code>的bean；</li><li><code>PrintChangeKeyUtils.printChange(changeEvent);</code> 表示打印发送变化的熟悉（可选）,<code>PrintChangeKeyUtils</code>定义为：</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.ctrip.framework.apollo.model.ConfigChange;</span><br><span class="line"><span class="keyword">import</span> com.ctrip.framework.apollo.model.ConfigChangeEvent;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.CollectionUtils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PrintChangeKeyUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">printChange</span><span class="params">(ConfigChangeEvent changeEvent)</span> </span>&#123;</span><br><span class="line">        Set&lt;String&gt; changeKeys = changeEvent.changedKeys();</span><br><span class="line">        <span class="keyword">if</span> (!CollectionUtils.isEmpty(changeKeys)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (String changeKey : changeKeys) &#123;</span><br><span class="line">                ConfigChange configChange = changeEvent.getChange(changeKey);</span><br><span class="line">                System.out.println(<span class="string">&quot;key:&quot;</span> + changeKey + <span class="string">&quot;;oldValue:&quot;</span> + configChange.getOldValue() + <span class="string">&quot;;newValue:&quot;</span> + configChange.getNewValue());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="方法二：基于EnvironmentChangeEvent实现刷新"><a href="#方法二：基于EnvironmentChangeEvent实现刷新" class="headerlink" title="方法二：基于EnvironmentChangeEvent实现刷新"></a>方法二：基于EnvironmentChangeEvent实现刷新</h2><ol><li>定义实体类</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(&quot;test.user&quot;)</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestUserProperties</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Boolean sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与方法一的差异是不使用<code>@RefreshScope</code>注解</p><ol start="2"><li>利用spring的事件驱动配合@ApolloConfigChangeListener监听实现bean的动态刷新：</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApolloDynamicConfigPropertiesRefresh</span>  <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    RefreshScope refreshScope;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApolloConfigChangeListener(value=&quot;config&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refresh</span><span class="params">(ConfigChangeEvent changeEvent)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        applicationContext.publishEvent(<span class="keyword">new</span> EnvironmentChangeEvent(changeEvent.changedKeys()));</span><br><span class="line"></span><br><span class="line">        PrintChangeKeyUtils.printChange(changeEvent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="两种方式动态刷新原理浅析："><a href="#两种方式动态刷新原理浅析：" class="headerlink" title="两种方式动态刷新原理浅析："></a>两种方式动态刷新原理浅析：</h2><h3 id="RefreshScope"><a href="#RefreshScope" class="headerlink" title="RefreshScope"></a>RefreshScope</h3><p>首先了解Spring中几个相关的类：</p><ul><li>注解@RefreshScope(<code>org.springframework.cloud.context.config.annotation.RefreshScope</code>)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Scope(&quot;refresh&quot;)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> RefreshScope &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Scope#proxyMode()</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> proxy mode</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function">ScopedProxyMode <span class="title">proxyMode</span><span class="params">()</span> <span class="keyword">default</span> ScopedProxyMode.TARGET_CLASS</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>注解@Scope(<code>org.springframework.context.annotation.Scope</code>)</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE, ElementType.METHOD&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Scope &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@AliasFor(&quot;scopeName&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AliasFor(&quot;value&quot;)</span></span><br><span class="line"><span class="function">String <span class="title">scopeName</span><span class="params">()</span> <span class="keyword">default</span> &quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">ScopedProxyMode <span class="title">proxyMode</span><span class="params">()</span> <span class="keyword">default</span> ScopedProxyMode.DEFAULT</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>接口Scope(<code>org.springframework.beans.factory.config.Scope</code>) </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Scope</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function">Object <span class="title">get</span><span class="params">(String name, ObjectFactory&lt;?&gt; objectFactory)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">Object <span class="title">remove</span><span class="params">(String name)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">registerDestructionCallback</span><span class="params">(String name, Runnable callback)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">Object <span class="title">resolveContextualObject</span><span class="params">(String key)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="function">String <span class="title">getConversationId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>类RefreshScope(<code>org.springframework.cloud.context.scope.refresh.RefreshScope</code>)  </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ManagedResource</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RefreshScope</span> <span class="keyword">extends</span> <span class="title">GenericScope</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span>,<span class="title">ApplicationListener</span>&lt;<span class="title">ContextRefreshedEvent</span>&gt;, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> ApplicationContext context;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> BeanDefinitionRegistry registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> eager = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> order = Ordered.LOWEST_PRECEDENCE - <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Creates a scope instance and gives it the default name: &quot;refresh&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RefreshScope</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>.setName(<span class="string">&quot;refresh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">this</span>.order;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrder</span><span class="params">(<span class="keyword">int</span> order)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.order = order;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setEager</span><span class="params">(<span class="keyword">boolean</span> eager)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.eager = eager;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.registry = registry;</span><br><span class="line"><span class="keyword">super</span>.postProcessBeanDefinitionRegistry(registry);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line">start(event);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">(ContextRefreshedEvent event)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (event.getApplicationContext() == <span class="keyword">this</span>.context &amp;&amp; <span class="keyword">this</span>.eager</span><br><span class="line">&amp;&amp; <span class="keyword">this</span>.registry != <span class="keyword">null</span>) &#123;</span><br><span class="line">eagerlyInitialize();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">eagerlyInitialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">for</span> (String name : <span class="keyword">this</span>.context.getBeanDefinitionNames()) &#123;</span><br><span class="line">BeanDefinition definition = <span class="keyword">this</span>.registry.getBeanDefinition(name);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.getName().equals(definition.getScope())</span><br><span class="line">&amp;&amp; !definition.isLazyInit()) &#123;</span><br><span class="line">Object bean = <span class="keyword">this</span>.context.getBean(name);</span><br><span class="line"><span class="keyword">if</span> (bean != <span class="keyword">null</span>) &#123;</span><br><span class="line">bean.getClass();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ManagedOperation(description = &quot;Dispose of the current instance of bean name &quot;</span></span><br><span class="line"><span class="meta">+ &quot;provided and force a refresh on next method execution.&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">refresh</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!name.startsWith(SCOPED_TARGET_PREFIX)) &#123;</span><br><span class="line"><span class="comment">// User wants to refresh the bean with this name but that isn&#x27;t the one in the</span></span><br><span class="line"><span class="comment">// cache...</span></span><br><span class="line">name = SCOPED_TARGET_PREFIX + name;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Ensure lifecycle is finished if bean was disposable</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">super</span>.destroy(name)) &#123;</span><br><span class="line"><span class="keyword">this</span>.context.publishEvent(<span class="keyword">new</span> RefreshScopeRefreshedEvent(name));</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ManagedOperation(description = &quot;Dispose of the current instance of all beans &quot;</span></span><br><span class="line"><span class="meta">+ &quot;in this scope and force a refresh on next method execution.&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>.destroy();</span><br><span class="line"><span class="keyword">this</span>.context.publishEvent(<span class="keyword">new</span> RefreshScopeRefreshedEvent());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext context)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.context = context;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>带有<code>@RefreshScope</code>注解后的Bean，在初始话的过程中，会通过<code>AnnotationScopeMetadataResolver#resolveScopeMetadata</code>提取元数据：  </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ScopeMetadata <span class="title">resolveScopeMetadata</span><span class="params">(BeanDefinition definition)</span> </span>&#123;</span><br><span class="line">    ScopeMetadata metadata = <span class="keyword">new</span> ScopeMetadata();</span><br><span class="line">    <span class="keyword">if</span> (definition <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">        AnnotatedBeanDefinition annDef = (AnnotatedBeanDefinition) definition;</span><br><span class="line">        AnnotationAttributes attributes = AnnotationConfigUtils.attributesFor(</span><br><span class="line">                annDef.getMetadata(), <span class="keyword">this</span>.scopeAnnotationType);</span><br><span class="line">        <span class="keyword">if</span> (attributes != <span class="keyword">null</span>) &#123;</span><br><span class="line">            metadata.setScopeName(attributes.getString(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">            ScopedProxyMode proxyMode = attributes.getEnum(<span class="string">&quot;proxyMode&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (proxyMode == ScopedProxyMode.DEFAULT) &#123;</span><br><span class="line">                proxyMode = <span class="keyword">this</span>.defaultProxyMode;</span><br><span class="line">            &#125;</span><br><span class="line">            metadata.setScopedProxyMode(proxyMode);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> metadata;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以理解为 <code>@RefreshScope</code> 是scopeName=”refresh”的 <code>@Scope</code>，其Bean的注册将通过<code>AnnotatedBeanDefinitionReader#registerBean</code>完成的：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">doRegisterBean</span><span class="params">(Class&lt;T&gt; beanClass, <span class="meta">@Nullable</span> String name,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="meta">@Nullable</span> Class&lt;? extends Annotation&gt;[] qualifiers, <span class="meta">@Nullable</span> Supplier&lt;T&gt; supplier,</span></span></span><br><span class="line"><span class="function"><span class="params"><span class="meta">@Nullable</span> BeanDefinitionCustomizer[] customizers)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">AnnotatedGenericBeanDefinition abd = <span class="keyword">new</span> AnnotatedGenericBeanDefinition(beanClass);</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">this</span>.conditionEvaluator.shouldSkip(abd.getMetadata())) &#123;</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">abd.setInstanceSupplier(supplier);</span><br><span class="line">ScopeMetadata scopeMetadata = <span class="keyword">this</span>.scopeMetadataResolver.resolveScopeMetadata(abd);</span><br><span class="line">abd.setScope(scopeMetadata.getScopeName());</span><br><span class="line">String beanName = (name != <span class="keyword">null</span> ? name : <span class="keyword">this</span>.beanNameGenerator.generateBeanName(abd, <span class="keyword">this</span>.registry));</span><br><span class="line"></span><br><span class="line">AnnotationConfigUtils.processCommonDefinitionAnnotations(abd);</span><br><span class="line"><span class="keyword">if</span> (qualifiers != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (Class&lt;? extends Annotation&gt; qualifier : qualifiers) &#123;</span><br><span class="line"><span class="keyword">if</span> (Primary.class == qualifier) &#123;</span><br><span class="line">abd.setPrimary(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (Lazy.class == qualifier) &#123;</span><br><span class="line">abd.setLazyInit(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">abd.addQualifier(<span class="keyword">new</span> AutowireCandidateQualifier(qualifier));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (customizers != <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="keyword">for</span> (BeanDefinitionCustomizer customizer : customizers) &#123;</span><br><span class="line">customizer.customize(abd);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BeanDefinitionHolder definitionHolder = <span class="keyword">new</span> BeanDefinitionHolder(abd, beanName);</span><br><span class="line">definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="keyword">this</span>.registry);</span><br><span class="line">BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, <span class="keyword">this</span>.registry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/test/dynamic/config&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DynamicConfigTestController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.user.name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.user.age&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;test.user.sex&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Boolean sex;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TestUserProperties userProperties;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">properties</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;name&quot;</span>, name);</span><br><span class="line">        map.put(<span class="string">&quot;age&quot;</span>, age);</span><br><span class="line">        map.put(<span class="string">&quot;sex&quot;</span>, sex);</span><br><span class="line">        map.put(<span class="string">&quot;user&quot;</span>, userProperties.toString());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://cloud.tencent.com/developer/article/1639579">apollo与springboot集成实现动态刷新配置</a></li><li><a href="https://www.jianshu.com/p/188013dd3d02">@RefreshScope那些事</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;普通字段&quot;&gt;&lt;a href=&quot;#普通字段&quot; class=&quot;headerlink&quot; title=&quot;普通字段&quot;&gt;&lt;/a&gt;普通字段&lt;/h1&gt;&lt;p&gt;在需要刷新的字段上使用&lt;code&gt;@value&lt;/code&gt;注解即可，例如：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Value(&amp;quot;$&amp;#123;test.user.name&amp;#125;&amp;quot;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; String name;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Value(&amp;quot;$&amp;#123;test.user.age&amp;#125;&amp;quot;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Integer age;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Value(&amp;quot;$&amp;#123;test.user.sex&amp;#125;&amp;quot;)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Boolean sex;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="微服务" scheme="https://www.wangfeng.pro/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
      <category term="配置中心" scheme="https://www.wangfeng.pro/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/"/>
    
    
      <category term="Apollo" scheme="https://www.wangfeng.pro/tags/Apollo/"/>
    
  </entry>
  
  <entry>
    <title>K8S中搭建Apollo</title>
    <link href="https://www.wangfeng.pro/2021/05/k8s%E4%B8%AD%E6%90%AD%E5%BB%BAapollo.html"/>
    <id>https://www.wangfeng.pro/2021/05/k8s中搭建apollo.html</id>
    <published>2021-05-10T03:19:03.000Z</published>
    <updated>2021-05-25T02:36:42.015Z</updated>
    
    <content type="html"><![CDATA[<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><ul><li>Rancher</li><li>k8s 1.20</li><li>Helm 3</li><li>MySQL数据库</li></ul><h1 id="添加Apollo-Helm-Chart仓库"><a href="#添加Apollo-Helm-Chart仓库" class="headerlink" title="添加Apollo Helm Chart仓库"></a>添加Apollo Helm Chart仓库</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add apollo https://www.apolloconfig.com/charts</span><br><span class="line">helm search repo apollo</span><br></pre></td></tr></table></figure><span id="more"></span><h1 id="数据库脚本"><a href="#数据库脚本" class="headerlink" title="数据库脚本"></a>数据库脚本</h1><ol><li><p>下载<a href="https://github.com/ctripcorp/apollo/tree/master/scripts/docker-quick-start/sql">apollo/scripts/docker-quick-start/sql</a>目录下的<code>apolloportaldb.sql</code>和<code>apolloconfigdb.sql</code>两个SQL脚本;</p></li><li><p>由于搭建的Apollo服务将会用于公司内网1套开发环境和6套测试环境，所以需要搭建1套<code>apollo-portal</code>服务和7套<code>apollo-configservice</code>和<code>apollo-adminservice</code>服务，对应的需要建立一套<code>ApolloPortalDB</code>和7套<code>ApolloConfigDB</code>:</p><ul><li>使用<code>apolloportaldb.sql</code>建立<code>ApolloConfigDB</code>库；</li><li>使用<code>apolloportaldb.sql</code>建立<code>ApolloConfigDB_20_21</code>、<code>ApolloConfigDB_20_2</code>、<code>ApolloConfigDB_20_207</code>、<code>ApolloConfigDB_20_22</code>、<code>ApolloConfigDB_20_76</code>、<code>ApolloConfigDB_20_91</code>、<code>ApolloConfigDB_20_105</code>库</li></ul></li></ol><h1 id="服务部署"><a href="#服务部署" class="headerlink" title="服务部署"></a>服务部署</h1><h3 id="部署apollo-configservice和apollo-adminservice"><a href="#部署apollo-configservice和apollo-adminservice" class="headerlink" title="部署apollo-configservice和apollo-adminservice"></a>部署apollo-configservice和apollo-adminservice</h3><div class='spoiler collapsed'>    <div class='spoiler-title'>            </div>    <div class='spoiler-content'>        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">helm install apollo-service-20-2 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.host=&lt;MYSQL_IP&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.port=&lt;MYSQL_PORT&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.userName=&lt;MYSQL_USERNAME&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.password=&lt;MYSQL_PASSWORD&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.dbName=ApolloConfigDB_20_2 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.service.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> configService.replicaCount=1 \</span><br><span class="line">    --<span class="built_in">set</span> adminService.replicaCount=1 \</span><br><span class="line">    -n apollo \</span><br><span class="line">    apollo/apollo-service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helm install apollo-service-20-207 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.host=&lt;MYSQL_IP&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.port=&lt;MYSQL_PORT&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.userName=&lt;MYSQL_USERNAME&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.password=&lt;MYSQL_PASSWORD&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.dbName=ApolloConfigDB_20_207 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.service.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> configService.replicaCount=1 \</span><br><span class="line">    --<span class="built_in">set</span> adminService.replicaCount=1 \</span><br><span class="line">    -n apollo \</span><br><span class="line">    apollo/apollo-service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helm install apollo-service-20-21 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.host=&lt;MYSQL_IP&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.port=&lt;MYSQL_PORT&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.userName=&lt;MYSQL_USERNAME&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.password=&lt;MYSQL_PASSWORD&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.dbName=ApolloConfigDB_20_21 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.service.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> configService.replicaCount=1 \</span><br><span class="line">    --<span class="built_in">set</span> adminService.replicaCount=1 \</span><br><span class="line">    -n apollo \</span><br><span class="line">    apollo/apollo-service</span><br><span class="line"></span><br><span class="line">helm install apollo-service-20-22 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.host=&lt;MYSQL_IP&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.port=&lt;MYSQL_PORT&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.userName=&lt;MYSQL_USERNAME&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.password=&lt;MYSQL_PASSWORD&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.dbName=ApolloConfigDB_20_22 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.service.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> configService.replicaCount=1 \</span><br><span class="line">    --<span class="built_in">set</span> adminService.replicaCount=1 \</span><br><span class="line">    -n apollo \</span><br><span class="line">    apollo/apollo-service</span><br><span class="line"></span><br><span class="line">helm install apollo-service-20-76 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.host=&lt;MYSQL_IP&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.port=&lt;MYSQL_PORT&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.userName=&lt;MYSQL_USERNAME&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.password=&lt;MYSQL_PASSWORD&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.dbName=ApolloConfigDB_20_76 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.service.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> configService.replicaCount=1 \</span><br><span class="line">    --<span class="built_in">set</span> adminService.replicaCount=1 \</span><br><span class="line">    -n apollo \</span><br><span class="line">    apollo/apollo-service</span><br><span class="line"></span><br><span class="line">helm install apollo-service-20-91 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.host=&lt;MYSQL_IP&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.port=&lt;MYSQL_PORT&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.userName=&lt;MYSQL_USERNAME&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.password=&lt;MYSQL_PASSWORD&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.dbName=ApolloConfigDB_20_91 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.service.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> configService.replicaCount=1 \</span><br><span class="line">    --<span class="built_in">set</span> adminService.replicaCount=1 \</span><br><span class="line">    -n apollo \</span><br><span class="line">    apollo/apollo-service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helm install apollo-service-20-105 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.host=&lt;MYSQL_IP&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.port=&lt;MYSQL_PORT&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.userName=&lt;MYSQL_USERNAME&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.password=&lt;MYSQL_PASSWORD&gt; \</span><br><span class="line">    --<span class="built_in">set</span> configdb.dbName=ApolloConfigDB_20_105 \</span><br><span class="line">    --<span class="built_in">set</span> configdb.service.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> configService.replicaCount=1 \</span><br><span class="line">    --<span class="built_in">set</span> adminService.replicaCount=1 \</span><br><span class="line">    -n apollo \</span><br><span class="line">    apollo/apollo-service</span><br></pre></td></tr></table></figure>    </div></div><h3 id="部署apollo-portal"><a href="#部署apollo-portal" class="headerlink" title="部署apollo-portal"></a>部署apollo-portal</h3><div class='spoiler collapsed'>    <div class='spoiler-title'>            </div>    <div class='spoiler-content'>        <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">helm install apollo-portal \</span><br><span class="line">    --<span class="built_in">set</span> portaldb.host=&lt;MYSQL_IP&gt; \</span><br><span class="line">    --<span class="built_in">set</span> portaldb.port=&lt;MYSQL_PORT&gt; \</span><br><span class="line">    --<span class="built_in">set</span> portaldb.userName=&lt;MYSQL_USERNAME&gt; \</span><br><span class="line">    --<span class="built_in">set</span> portaldb.password=&lt;MYSQL_PASSWORD&gt; \</span><br><span class="line">    --<span class="built_in">set</span> portaldb.dbName=ApolloPortalDB \</span><br><span class="line">    --<span class="built_in">set</span> portaldb.service.enabled=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> config.envs=<span class="string">&quot;dev21\,test2\,test22\,test76\,test91\,test105\,test207&quot;</span> \</span><br><span class="line">    --<span class="built_in">set</span> config.metaServers.dev21=http://apollo-service-20-21-apollo-configservice.apollo:8080 \</span><br><span class="line">    --<span class="built_in">set</span> config.metaServers.test2=http://apollo-service-20-2-apollo-configservice.apollo:8080 \</span><br><span class="line">    --<span class="built_in">set</span> config.metaServers.test22=http://apollo-service-20-22-apollo-configservice.apollo:8080 \</span><br><span class="line">    --<span class="built_in">set</span> config.metaServers.test76=http://apollo-service-20-76-apollo-configservice.apollo:8080 \</span><br><span class="line">    --<span class="built_in">set</span> config.metaServers.test91=http://apollo-service-20-91-apollo-configservice.apollo:8080 \</span><br><span class="line">    --<span class="built_in">set</span> config.metaServers.test105=http://apollo-service-20-105-apollo-configservice.apollo:8080 \</span><br><span class="line">    --<span class="built_in">set</span> config.metaServers.test207=http://apollo-service-20-207-apollo-configservice.apollo:8080 \</span><br><span class="line">    --<span class="built_in">set</span> replicaCount=1 \</span><br><span class="line">    -n apollo \</span><br><span class="line">    apollo/apollo-portal</span><br></pre></td></tr></table></figure>    </div></div><h3 id="在Rancher配置端口映射"><a href="#在Rancher配置端口映射" class="headerlink" title="在Rancher配置端口映射"></a>在Rancher配置端口映射</h3><h4 id="准备工作：搭建好metalb，做好虚拟ip规划"><a href="#准备工作：搭建好metalb，做好虚拟ip规划" class="headerlink" title="准备工作：搭建好metalb，做好虚拟ip规划"></a>准备工作：搭建好metalb，做好虚拟ip规划</h4><ul><li><p>metalb搭建：参考<a href="https://metallb.universe.tf/installation/">metalb官方安装文档</a></p></li><li><p>IP规划</p><ul><li><p>Apollo Portal<br>192.168.40.31:8070</p></li><li><p>Apollo ConfigServer</p><table><thead><tr><th>环境</th><th>ip:port</th></tr></thead><tbody><tr><td>dev21</td><td>192.168.40.31:8080</td></tr><tr><td>test02</td><td>192.168.40.32:8080</td></tr><tr><td>test22</td><td>192.168.40.33:8080</td></tr><tr><td>test76</td><td>192.168.40.34:8080</td></tr><tr><td>test91</td><td>192.168.40.35:8080</td></tr><tr><td>test105</td><td>192.168.40.36:8080</td></tr><tr><td>test207</td><td>192.168.40.37:8080</td></tr></tbody></table></li></ul></li></ul><h4 id="部署脚本"><a href="#部署脚本" class="headerlink" title="部署脚本"></a>部署脚本</h4><div class='spoiler collapsed'>    <div class='spoiler-title'>            </div>    <div class='spoiler-content'>        <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cattle.io/creator:</span> <span class="string">norman</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apollo-portal-port</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">apollo</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">metallb.universe.tf/allow-shared-ip:</span> <span class="string">ip_192_168_40_31</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">loadBalancerIP:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.31</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8070</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8070</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">apollo-portal</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cattle.io/creator:</span> <span class="string">norman</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apollo-20-21-port</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">apollo</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">metallb.universe.tf/allow-shared-ip:</span> <span class="string">ip_192_168_40_31</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">loadBalancerIP:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.31</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">apollo-service-20-21-apollo-configservice</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cattle.io/creator:</span> <span class="string">norman</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apollo-20-02-port</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">apollo</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">metallb.universe.tf/allow-shared-ip:</span> <span class="string">ip_192_168_40_32</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">loadBalancerIP:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.32</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">apollo-service-20-2-apollo-configservice</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cattle.io/creator:</span> <span class="string">norman</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apollo-20-22-port</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">apollo</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">metallb.universe.tf/allow-shared-ip:</span> <span class="string">ip_192_168_40_33</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">loadBalancerIP:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.33</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">apollo-service-20-22-apollo-configservice</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cattle.io/creator:</span> <span class="string">norman</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apollo-20-76-port</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">apollo</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">metallb.universe.tf/allow-shared-ip:</span> <span class="string">ip_192_168_40_34</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">loadBalancerIP:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.34</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">apollo-service-20-76-apollo-configservice</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cattle.io/creator:</span> <span class="string">norman</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apollo-20-91-port</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">apollo</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">metallb.universe.tf/allow-shared-ip:</span> <span class="string">ip_192_168_40_35</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">loadBalancerIP:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.35</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">apollo-service-20-91-apollo-configservice</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cattle.io/creator:</span> <span class="string">norman</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apollo-20-105-port</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">apollo</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">metallb.universe.tf/allow-shared-ip:</span> <span class="string">ip_192_168_40_36</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">loadBalancerIP:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.36</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">apollo-service-20-105-apollo-configservice</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">cattle.io/creator:</span> <span class="string">norman</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">apollo-20-207-port</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">apollo</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">metallb.universe.tf/allow-shared-ip:</span> <span class="string">ip_192_168_40_37</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">externalTrafficPolicy:</span> <span class="string">Cluster</span></span><br><span class="line">  <span class="attr">loadBalancerIP:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.37</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">apollo-service-20-207-apollo-configservice</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br></pre></td></tr></table></figure>    </div></div><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://www.apolloconfig.com/#/zh/deployment/distributed-deployment-guide?id=_241-%e5%9f%ba%e4%ba%8ekubernetes%e5%8e%9f%e7%94%9f%e6%9c%8d%e5%8a%a1%e5%8f%91%e7%8e%b0">基于kubernetes原生服务发现</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;环境准备&quot;&gt;&lt;a href=&quot;#环境准备&quot; class=&quot;headerlink&quot; title=&quot;环境准备&quot;&gt;&lt;/a&gt;环境准备&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;Rancher&lt;/li&gt;
&lt;li&gt;k8s 1.20&lt;/li&gt;
&lt;li&gt;Helm 3&lt;/li&gt;
&lt;li&gt;MySQL数据库&lt;/li&gt;
&lt;/ul&gt;
&lt;h1 id=&quot;添加Apollo-Helm-Chart仓库&quot;&gt;&lt;a href=&quot;#添加Apollo-Helm-Chart仓库&quot; class=&quot;headerlink&quot; title=&quot;添加Apollo Helm Chart仓库&quot;&gt;&lt;/a&gt;添加Apollo Helm Chart仓库&lt;/h1&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;helm repo add apollo https://www.apolloconfig.com/charts&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;helm search repo apollo&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="微服务" scheme="https://www.wangfeng.pro/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    
      <category term="配置中心" scheme="https://www.wangfeng.pro/categories/%E5%BE%AE%E6%9C%8D%E5%8A%A1/%E9%85%8D%E7%BD%AE%E4%B8%AD%E5%BF%83/"/>
    
    
      <category term="Apollo" scheme="https://www.wangfeng.pro/tags/Apollo/"/>
    
      <category term="K8S" scheme="https://www.wangfeng.pro/tags/K8S/"/>
    
  </entry>
  
  <entry>
    <title>一致性Hash算法</title>
    <link href="https://www.wangfeng.pro/2021/04/%E4%B8%80%E8%87%B4%E6%80%A7hash%E7%AE%97%E6%B3%95.html"/>
    <id>https://www.wangfeng.pro/2021/04/一致性hash算法.html</id>
    <published>2021-04-27T11:08:03.000Z</published>
    <updated>2021-05-23T08:24:53.244Z</updated>
    
    <content type="html"><![CDATA[<h1 id="算法实现"><a href="#算法实现" class="headerlink" title="算法实现"></a>算法实现</h1><h2 id="不带虚拟节点的实现"><a href="#不带虚拟节点的实现" class="headerlink" title="不带虚拟节点的实现"></a>不带虚拟节点的实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.SortedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 不带虚拟节点的一致性Hash算法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsistentHashingWithoutVirtualNode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//待添加入Hash环的服务器列表</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] servers = &#123;<span class="string">&quot;192.168.0.0:111&quot;</span>, <span class="string">&quot;192.168.0.1:111&quot;</span>,</span><br><span class="line">            <span class="string">&quot;192.168.0.2:111&quot;</span>, <span class="string">&quot;192.168.0.3:111&quot;</span>, <span class="string">&quot;192.168.0.4:111&quot;</span>&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//key表示服务器的hash值，value表示服务器</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SortedMap&lt;Integer, String&gt; sortedMap = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//程序初始化，将所有的服务器放入sortedMap中</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; servers.length; i++) &#123;</span><br><span class="line">            String server = servers[i];</span><br><span class="line">            <span class="keyword">int</span> hash = getHash(server);</span><br><span class="line">            System.out.println(<span class="string">&quot;[&quot;</span> + server + <span class="string">&quot;]加入集合中, 其Hash值为&quot;</span> + hash);</span><br><span class="line">            sortedMap.put(hash, server);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//得到应当路由到的结点</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">getServer</span><span class="params">(String key)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//得到该key的hash值</span></span><br><span class="line">        <span class="keyword">int</span> hash = getHash(key);</span><br><span class="line">        <span class="comment">//得到大于该Hash值的所有Map</span></span><br><span class="line">        SortedMap&lt;Integer, String&gt; subMap = sortedMap.tailMap(hash);</span><br><span class="line">        <span class="keyword">if</span> (subMap.isEmpty()) &#123;</span><br><span class="line">            <span class="comment">//如果没有比该key的hash值大的，则从第一个node开始</span></span><br><span class="line">            Integer i = sortedMap.firstKey();</span><br><span class="line">            <span class="comment">//返回对应的服务器</span></span><br><span class="line">            <span class="keyword">return</span> sortedMap.get(i);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//第一个Key就是顺时针过去离node最近的那个结点</span></span><br><span class="line">            Integer i = subMap.firstKey();</span><br><span class="line">            <span class="comment">//返回对应的服务器</span></span><br><span class="line">            <span class="keyword">return</span> subMap.get(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//使用FNV1_32_HASH算法计算服务器的Hash值,这里不使用重写hashCode的方法，最终效果没区别</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getHash</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> p = <span class="number">16777619</span>;</span><br><span class="line">        <span class="keyword">int</span> hash = (<span class="keyword">int</span>) <span class="number">2166136261L</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length(); i++)</span><br><span class="line">            hash = (hash ^ str.charAt(i)) * p;</span><br><span class="line">        hash += hash &lt;&lt; <span class="number">13</span>;</span><br><span class="line">        hash ^= hash &gt;&gt; <span class="number">7</span>;</span><br><span class="line">        hash += hash &lt;&lt; <span class="number">3</span>;</span><br><span class="line">        hash ^= hash &gt;&gt; <span class="number">17</span>;</span><br><span class="line">        hash += hash &lt;&lt; <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果算出来的值为负数则取其绝对值</span></span><br><span class="line">        <span class="keyword">if</span> (hash &lt; <span class="number">0</span>)</span><br><span class="line">            hash = Math.abs(hash);</span><br><span class="line">        <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        String[] keys = &#123;<span class="string">&quot;太阳&quot;</span>, <span class="string">&quot;月亮&quot;</span>, <span class="string">&quot;星星&quot;</span>&#125;;</span><br><span class="line">        <span class="keyword">for</span> (String key : keys)</span><br><span class="line">            System.out.println(<span class="string">&quot;[&quot;</span> + key + <span class="string">&quot;]的hash值为&quot;</span> + getHash(key)</span><br><span class="line">                    + <span class="string">&quot;, 被路由到结点[&quot;</span> + getServer(key) + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="带虚拟节点的实现"><a href="#带虚拟节点的实现" class="headerlink" title="带虚拟节点的实现"></a>带虚拟节点的实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.SortedMap;</span><br><span class="line"><span class="keyword">import</span> java.util.TreeMap;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.locks.StampedLock;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:wf2311@163.com&quot;&gt;wf2311&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021/4/25 19:08.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsistentHashingWithVirtualNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NODE_SPILT = <span class="string">&quot;@@&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NODE_PREFIX = <span class="string">&quot;VN&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * key表示服务器的hash,value表示服务器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SortedMap&lt;Integer, String&gt; map = <span class="keyword">new</span> TreeMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 服务器节点</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; servers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 虚拟节点数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> virtualNodeNum;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StampedLock lock = <span class="keyword">new</span> StampedLock();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ConsistentHashingWithVirtualNode</span><span class="params">(List&lt;String&gt; servers, <span class="keyword">int</span> virtualNodeNum)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.servers = servers;</span><br><span class="line">        <span class="keyword">this</span>.virtualNodeNum = virtualNodeNum;</span><br><span class="line">        init();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (String server : servers) &#123;</span><br><span class="line">            addServer(server);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addServer</span><span class="params">(String server)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamp = lock.writeLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; virtualNodeNum; i++) &#123;</span><br><span class="line">                String virtual = server + NODE_SPILT + NODE_PREFIX + i;</span><br><span class="line">                <span class="keyword">int</span> hash = getHash(virtual);</span><br><span class="line">                map.put(hash, virtual);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeServer</span><span class="params">(String server)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamp = lock.writeLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; virtualNodeNum; i++) &#123;</span><br><span class="line">                String virtual = server + NODE_SPILT + NODE_PREFIX + i;</span><br><span class="line">                map.remove(getHash(virtual));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeServer</span><span class="params">(String server, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> stamp = lock.writeLock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String virtual = server + NODE_SPILT + NODE_PREFIX + i;</span><br><span class="line">            <span class="keyword">int</span> hash = getHash(virtual);</span><br><span class="line">            map.put(hash, virtual);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">findServer</span><span class="params">(String request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> hash = getHash(request);</span><br><span class="line">        <span class="keyword">long</span> stamp = lock.tryOptimisticRead();</span><br><span class="line">        String server = getServerByHashKey(hash);</span><br><span class="line">        <span class="keyword">if</span> (!lock.validate(stamp)) &#123;</span><br><span class="line">            stamp = lock.readLock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                server = getServerByHashKey(hash);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlockRead(stamp);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> server;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getServerByHashKey</span><span class="params">(<span class="keyword">int</span> hash)</span> </span>&#123;</span><br><span class="line">        SortedMap&lt;Integer, String&gt; subMap = map.tailMap(hash);</span><br><span class="line">        Integer targetServerKey = subMap.isEmpty() ? map.firstKey() : subMap.firstKey();</span><br><span class="line">        String virtual = map.get(targetServerKey);</span><br><span class="line">        <span class="keyword">if</span> (virtual != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> virtual.split(NODE_SPILT)[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getHash</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> p = <span class="number">16777619</span>;</span><br><span class="line">        <span class="keyword">int</span> hash = (<span class="keyword">int</span>) <span class="number">2166136261L</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; str.length(); i++)</span><br><span class="line">            hash = (hash ^ str.charAt(i)) * p;</span><br><span class="line">        hash += hash &lt;&lt; <span class="number">13</span>;</span><br><span class="line">        hash ^= hash &gt;&gt; <span class="number">7</span>;</span><br><span class="line">        hash += hash &lt;&lt; <span class="number">3</span>;</span><br><span class="line">        hash ^= hash &gt;&gt; <span class="number">17</span>;</span><br><span class="line">        hash += hash &lt;&lt; <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果算出来的值为负数则取其绝对值</span></span><br><span class="line">        <span class="keyword">if</span> (hash &lt; <span class="number">0</span>)</span><br><span class="line">            hash = Math.abs(hash);</span><br><span class="line">        <span class="keyword">return</span> hash;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;算法实现&quot;&gt;&lt;a href=&quot;#算法实现&quot; class=&quot;headerlink&quot; title=&quot;算法实现&quot;&gt;&lt;/a&gt;算法实现&lt;/h1&gt;&lt;h2 id=&quot;不带虚拟节点的实现&quot;&gt;&lt;a href=&quot;#不带虚拟节点的实现&quot; class=&quot;headerlink&quot; title=
      
    
    </summary>
    
      <category term="算法" scheme="https://www.wangfeng.pro/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="分布式" scheme="https://www.wangfeng.pro/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>漏桶算法</title>
    <link href="https://www.wangfeng.pro/2021/04/%E6%BC%8F%E6%A1%B6%E7%AE%97%E6%B3%95.html"/>
    <id>https://www.wangfeng.pro/2021/04/漏桶算法.html</id>
    <published>2021-04-25T03:52:03.000Z</published>
    <updated>2021-05-23T08:28:48.862Z</updated>
    
    <content type="html"><![CDATA[<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:wf2311@163.com&quot;&gt;wf2311&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2021/4/25 11:52.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LeakyBucketRateLimiter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 桶的大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> bucket;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 桶的已用量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> used;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 桶的流出速率</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> rate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 流出速率单位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TimeUnit rateUnit;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> perMillisRadio;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 最新刷新时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">long</span> lastRefreshTime;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LeakyBucketRateLimiter <span class="title">create</span><span class="params">(<span class="keyword">long</span> bucket, <span class="keyword">int</span> rate, TimeUnit rateUnit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LeakyBucketRateLimiter(bucket, rate, rateUnit);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">LeakyBucketRateLimiter</span><span class="params">(<span class="keyword">long</span> bucket, <span class="keyword">int</span> rate, TimeUnit rateUnit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.bucket = bucket;</span><br><span class="line">        <span class="keyword">this</span>.rate = rate;</span><br><span class="line">        <span class="keyword">this</span>.rateUnit = rateUnit;</span><br><span class="line">        <span class="keyword">this</span>.perMillisRadio = convertMillisRadio();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">convertMillisRadio</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (rateUnit) &#123;</span><br><span class="line">            <span class="keyword">case</span> MILLISECONDS:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">case</span> SECONDS:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1000</span>;</span><br><span class="line">            <span class="keyword">case</span> MINUTES:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1000</span> * <span class="number">60</span>;</span><br><span class="line">            <span class="keyword">case</span> HOURS:</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">refreshBucketUsed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">if</span> (lastRefreshTime &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">long</span> n = (now - lastRefreshTime) / perMillisRadio;</span><br><span class="line">            used = Math.max(<span class="number">0</span>, used - n * rate);</span><br><span class="line">        &#125;</span><br><span class="line">        lastRefreshTime = now;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> tryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">tryAcquire</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//刷新桶的使用量</span></span><br><span class="line">        refreshBucketUsed();</span><br><span class="line">        <span class="comment">//如果桶未满，则获取成功</span></span><br><span class="line">        <span class="keyword">if</span> (used + n &lt;= bucket) &#123;</span><br><span class="line">            used += n;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;实现&quot;&gt;&lt;a href=&quot;#实现&quot; class=&quot;headerlink&quot; title=&quot;实现&quot;&gt;&lt;/a&gt;实现&lt;/h1&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span c
      
    
    </summary>
    
      <category term="算法" scheme="https://www.wangfeng.pro/categories/%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="限流" scheme="https://www.wangfeng.pro/tags/%E9%99%90%E6%B5%81/"/>
    
  </entry>
  
  <entry>
    <title>Queue</title>
    <link href="https://www.wangfeng.pro/2020/06/queue.html"/>
    <id>https://www.wangfeng.pro/2020/06/queue.html</id>
    <published>2020-06-18T12:14:24.000Z</published>
    <updated>2021-05-24T12:22:54.344Z</updated>
    
    <content type="html"><![CDATA[<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/images/20210524194528.svg"></object></div><span id="more"></span><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;总览&quot;&gt;&lt;a href=&quot;#总览&quot; class=&quot;headerlink&quot; title=&quot;总览&quot;&gt;&lt;/a&gt;总览&lt;/h1&gt;&lt;div class=&quot;post-svg-container&quot;&gt;
    &lt;object type=&quot;image/svg+xml&quot; data=&quot;https://file.wf2311.com/images/20210524194528.svg&quot;&gt;&lt;/object&gt;
&lt;/div&gt;
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="容器" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="Queue" scheme="https://www.wangfeng.pro/tags/Queue/"/>
    
      <category term="Dueue" scheme="https://www.wangfeng.pro/tags/Dueue/"/>
    
  </entry>
  
  <entry>
    <title>Set</title>
    <link href="https://www.wangfeng.pro/2020/06/set.html"/>
    <id>https://www.wangfeng.pro/2020/06/set.html</id>
    <published>2020-06-17T12:14:24.000Z</published>
    <updated>2021-05-24T12:22:49.931Z</updated>
    
    <content type="html"><![CDATA[<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/images/20210524193018.svg"></object></div><span id="more"></span><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;总览&quot;&gt;&lt;a href=&quot;#总览&quot; class=&quot;headerlink&quot; title=&quot;总览&quot;&gt;&lt;/a&gt;总览&lt;/h1&gt;&lt;div class=&quot;post-svg-container&quot;&gt;
    &lt;object type=&quot;image/svg+xml&quot; data=&quot;https://file.wf2311.com/images/20210524193018.svg&quot;&gt;&lt;/object&gt;
&lt;/div&gt;
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="容器" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="Set" scheme="https://www.wangfeng.pro/tags/Set/"/>
    
  </entry>
  
  <entry>
    <title>NavigableMap</title>
    <link href="https://www.wangfeng.pro/2020/06/navigablemap.html"/>
    <id>https://www.wangfeng.pro/2020/06/navigablemap.html</id>
    <published>2020-06-16T14:15:24.000Z</published>
    <updated>2021-05-24T12:22:01.902Z</updated>
    
    <content type="html"><![CDATA[<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/images/20210524201046.svg"></object></div><div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/images/20210524201135.svg"></object></div><span id="more"></span><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;总览&quot;&gt;&lt;a href=&quot;#总览&quot; class=&quot;headerlink&quot; title=&quot;总览&quot;&gt;&lt;/a&gt;总览&lt;/h1&gt;&lt;div class=&quot;post-svg-container&quot;&gt;
    &lt;object type=&quot;image/svg+xml&quot; data=&quot;https://file.wf2311.com/images/20210524201046.svg&quot;&gt;&lt;/object&gt;
&lt;/div&gt;

&lt;div class=&quot;post-svg-container&quot;&gt;
    &lt;object type=&quot;image/svg+xml&quot; data=&quot;https://file.wf2311.com/images/20210524201135.svg&quot;&gt;&lt;/object&gt;
&lt;/div&gt;
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="容器" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/"/>
    
      <category term="Map" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/Map/"/>
    
    
      <category term="Map" scheme="https://www.wangfeng.pro/tags/Map/"/>
    
  </entry>
  
  <entry>
    <title>SortedMap</title>
    <link href="https://www.wangfeng.pro/2020/06/sortedmap.html"/>
    <id>https://www.wangfeng.pro/2020/06/sortedmap.html</id>
    <published>2020-06-16T14:14:24.000Z</published>
    <updated>2021-05-24T12:22:01.904Z</updated>
    
    <content type="html"><![CDATA[<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/images/20210524200509.svg"></object></div><span id="more"></span><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;总览&quot;&gt;&lt;a href=&quot;#总览&quot; class=&quot;headerlink&quot; title=&quot;总览&quot;&gt;&lt;/a&gt;总览&lt;/h1&gt;&lt;div class=&quot;post-svg-container&quot;&gt;
    &lt;object type=&quot;image/svg+xml&quot; data=&quot;https://file.wf2311.com/images/20210524200509.svg&quot;&gt;&lt;/object&gt;
&lt;/div&gt;
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="容器" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/"/>
    
      <category term="Map" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/Map/"/>
    
    
      <category term="Map" scheme="https://www.wangfeng.pro/tags/Map/"/>
    
  </entry>
  
  <entry>
    <title>TreeMap</title>
    <link href="https://www.wangfeng.pro/2020/06/treemap.html"/>
    <id>https://www.wangfeng.pro/2020/06/treemap.html</id>
    <published>2020-06-16T13:14:24.000Z</published>
    <updated>2021-05-25T02:39:42.224Z</updated>
    
    <content type="html"><![CDATA[<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/images/20210524195618.svg"></object></div><span id="more"></span><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;总览&quot;&gt;&lt;a href=&quot;#总览&quot; class=&quot;headerlink&quot; title=&quot;总览&quot;&gt;&lt;/a&gt;总览&lt;/h1&gt;&lt;div class=&quot;post-svg-container&quot;&gt;
    &lt;object type=&quot;image/svg+xml&quot; data=&quot;https://file.wf2311.com/images/20210524195618.svg&quot;&gt;&lt;/object&gt;
&lt;/div&gt;
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="容器" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/"/>
    
      <category term="Map" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/Map/"/>
    
    
      <category term="Map" scheme="https://www.wangfeng.pro/tags/Map/"/>
    
  </entry>
  
  <entry>
    <title>Map</title>
    <link href="https://www.wangfeng.pro/2020/06/map.html"/>
    <id>https://www.wangfeng.pro/2020/06/map.html</id>
    <published>2020-06-16T12:14:24.000Z</published>
    <updated>2021-05-24T12:22:45.733Z</updated>
    
    <content type="html"><![CDATA[<h1 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h1><div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/images/20210524194324.svg"></object></div><span id="more"></span><h1 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h1><div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/images/20210524195049.svg"></object></div><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;总览&quot;&gt;&lt;a href=&quot;#总览&quot; class=&quot;headerlink&quot; title=&quot;总览&quot;&gt;&lt;/a&gt;总览&lt;/h1&gt;&lt;div class=&quot;post-svg-container&quot;&gt;
    &lt;object type=&quot;image/svg+xml&quot; data=&quot;https://file.wf2311.com/images/20210524194324.svg&quot;&gt;&lt;/object&gt;
&lt;/div&gt;
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="容器" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="Map" scheme="https://www.wangfeng.pro/tags/Map/"/>
    
  </entry>
  
  <entry>
    <title>List</title>
    <link href="https://www.wangfeng.pro/2020/06/list.html"/>
    <id>https://www.wangfeng.pro/2020/06/list.html</id>
    <published>2020-06-15T12:14:24.000Z</published>
    <updated>2021-05-24T12:22:38.344Z</updated>
    
    <content type="html"><![CDATA[<div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/images/20210524142504.svg"></object></div><span id="more"></span><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;div class=&quot;post-svg-container&quot;&gt;
    &lt;object type=&quot;image/svg+xml&quot; data=&quot;https://file.wf2311.com/images/20210524142504.svg&quot;&gt;&lt;/object&gt;
&lt;/div&gt;
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="容器" scheme="https://www.wangfeng.pro/categories/Java/%E5%AE%B9%E5%99%A8/"/>
    
    
      <category term="List" scheme="https://www.wangfeng.pro/tags/List/"/>
    
  </entry>
  
  <entry>
    <title>02、注册中心与CAP理论</title>
    <link href="https://www.wangfeng.pro/2020/05/02%E3%80%81%E6%B3%A8%E5%86%8C%E4%B8%AD%E5%BF%83%E4%B8%8Ecap%E7%90%86%E8%AE%BA.html"/>
    <id>https://www.wangfeng.pro/2020/05/02、注册中心与cap理论.html</id>
    <published>2020-05-17T07:36:00.000Z</published>
    <updated>2021-05-23T02:17:49.059Z</updated>
    
    <content type="html"><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="OOPS, these decrypted content may changed, but you can still have a look.">  <script id="hbeData" type="hbeData" data-hmacdigest="f5434f8d616ace0d7cfa2d90318a18488be628fb1d64ab8b87899ae3442910c5">f48401abf4af5ea52f379292f7c52cdee04aaad3c4e76cbf5fb2b7117946b99a083099e166ec30ee523f511c69cad33ef09a118837889c00f08b333563068612f9234df138fc6310441b63371d02b09839f336f72afa3b9f8e22e52c3de67e4fb0fd56fe4272f536df59ad27222fe3befef8b7921c5eb95a19493cdfd79cdca05c0c0772267b5c82fb84185f5c72f57900e551552afc0c52605aee79fbd59aa84dfeddae744860363bb2b2ca5b6d0f07236eea3c26612f7a2e19905784ac20fd1c376e05657a8b2fddf7319df05a468bc251043d034c4294c748fee1ebeff2e5564d66177f2e4d17f5d6445d57f6350e5cf3b473c61e32f68f1864540fbaba1073969a97bb203494c585b8dbb96e951611fdb99964a6142098418d2aadf95962ddc5c3e19ce18d33feea57264a97524881f2ecb53923991d0de540ca727057de786216d9a5d9346d827e003a6ec67b7870b0fdce529f7e6f8f47bd59aab8ee1cc62ceea961249f16b10c94e8b43479bd9df6e3d24e2bcaae2582e1096ca468597d1084cf0487da3be551d1427eff40d8366659a743b9f081735384d7a180b9bb0e967e86aa73571aa7a798bc009542440189ae49416fc85906e8f0bd48471c4beca159633dd4d587851e15b3fb254032c1dc5e2b598e43b46010bce964b1be126ba43937534a77380a39d4c00eda1bd0cc67495fb95afe866666566144edb03b919b004dce5664d7e97d2b65ca0f515f47cf178183300bcbfa93ecce33d5611d3e7ccef3d232d4f44ad421b8f3a949947f3e8caa1fa3b635de98ebf74ad3bcd87bf75c4d5fb3dc51559e1a6b7397016f</script>  <div class="hbe hbe-content">    <div class="hbe hbe-input hbe-input-default">      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">        <span class="hbe hbe-input-label-content hbe-input-label-content-default">输入密码，查看文章</span>      </label>    </div>  </div></div><script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      未完成
    
    </summary>
    
      <category term="分布式" scheme="https://www.wangfeng.pro/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
      <category term="分布式协议" scheme="https://www.wangfeng.pro/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%AE%AE/"/>
    
    
      <category term="nacos" scheme="https://www.wangfeng.pro/tags/nacos/"/>
    
      <category term="cap" scheme="https://www.wangfeng.pro/tags/cap/"/>
    
  </entry>
  
  <entry>
    <title>01、CAP与BASE理论</title>
    <link href="https://www.wangfeng.pro/2020/05/01%E3%80%81cap%E4%B8%8Ebase%E7%90%86%E8%AE%BA.html"/>
    <id>https://www.wangfeng.pro/2020/05/01、cap与base理论.html</id>
    <published>2020-05-17T06:38:43.000Z</published>
    <updated>2021-05-18T03:34:44.417Z</updated>
    
    <content type="html"><![CDATA[<h1 id="CAP"><a href="#CAP" class="headerlink" title="CAP"></a>CAP</h1><h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><ul><li>一致性（Consistency）： 除非读取失败，否则不管访问的是哪个节点，在同一时间的数据返回的数据都是完全一致的；</li><li>可用性（Availability）：服务总是能正常响应数据，但不保证是最新数据；</li><li>分区容错性（Partition Tolerance）：在分布式系统内，即使因部分节点或者网络分区故障，导致任意数量的请求响应丢失或者延迟已经发送，后续系统仍能够对外提供服务；  </li></ul><h2 id="侧重点"><a href="#侧重点" class="headerlink" title="侧重点"></a>侧重点</h2><ul><li>一致性强调的不是数据完整性，而是各个节点之间数据一致；</li><li>可用性强调的是服务可用，但不保证数据的一致；</li><li>分区容错性强调的是对分区故障的容错能力，即分布式系统不会因为已经发生过的故障导致整个系统会挂掉；</li></ul><h2 id="CAP权衡"><a href="#CAP权衡" class="headerlink" title="CAP权衡"></a>CAP权衡</h2><h3 id="CA"><a href="#CA" class="headerlink" title="CA"></a>CA</h3><p>由于在分布式系统中，由于网络延迟或网络分区的存在，P是一个基本要求，CA在分布式系统中几乎不存在；</p><h3 id="CP"><a href="#CP" class="headerlink" title="CP"></a>CP</h3><p>必须保证分布式系统的一致性，以至于可以牺牲掉系统的可用作容许系统停机或长时间无响应。例如像Redis、HBASE等分布式存储系统以及想Zookeeper这种分布式协调组件，必须要保证数据的一致性；</p><h3 id="AP"><a href="#AP" class="headerlink" title="AP"></a>AP</h3><p>牺牲分布式系统的强一致性，保证分布式系统的可用性；</p><h1 id="BASE理论"><a href="#BASE理论" class="headerlink" title="BASE理论"></a>BASE理论</h1><h2 id="定义-1"><a href="#定义-1" class="headerlink" title="定义"></a>定义</h2><p><strong>BASE</strong>是Basically Available（基本可用）、Soft state（软状态）和Eventually consistent（最终一致性）三个短语的简写，BASE是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的结论，是基于CAP定理逐步演化而来的，其核心思想是即使无法做到强一致性（Strong consistency），但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性（Eventual consistency）。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://zhuanlan.zhihu.com/p/50990721">轻松理解CAP理论</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;CAP&quot;&gt;&lt;a href=&quot;#CAP&quot; class=&quot;headerlink&quot; title=&quot;CAP&quot;&gt;&lt;/a&gt;CAP&lt;/h1&gt;&lt;h2 id=&quot;定义&quot;&gt;&lt;a href=&quot;#定义&quot; class=&quot;headerlink&quot; title=&quot;定义&quot;&gt;&lt;/a&gt;定义&lt;/h2&gt;&lt;u
      
    
    </summary>
    
      <category term="分布式" scheme="https://www.wangfeng.pro/categories/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
      <category term="分布式协议" scheme="https://www.wangfeng.pro/categories/%E5%88%86%E5%B8%83%E5%BC%8F/%E5%88%86%E5%B8%83%E5%BC%8F%E5%8D%8F%E8%AE%AE/"/>
    
    
      <category term="CAP" scheme="https://www.wangfeng.pro/tags/CAP/"/>
    
      <category term="BASE" scheme="https://www.wangfeng.pro/tags/BASE/"/>
    
  </entry>
  
  <entry>
    <title>让处于事务中的特定代码在事务提交成功后再执行</title>
    <link href="https://www.wangfeng.pro/2019/11/%E8%AE%A9%E5%A4%84%E4%BA%8E%E4%BA%8B%E5%8A%A1%E4%B8%AD%E7%9A%84%E7%89%B9%E5%AE%9A%E4%BB%A3%E7%A0%81%E5%9C%A8%E4%BA%8B%E5%8A%A1%E6%8F%90%E4%BA%A4%E6%88%90%E5%8A%9F%E5%90%8E%E5%86%8D%E6%89%A7%E8%A1%8C.html"/>
    <id>https://www.wangfeng.pro/2019/11/让处于事务中的特定代码在事务提交成功后再执行.html</id>
    <published>2019-11-19T12:11:43.000Z</published>
    <updated>2021-05-14T13:06:17.456Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>之前遇到过一个这样的问题：在服务A里的执行一个保存数据库方法，数据保存成功后会将主键ID通过MQ发送给服务B,服务B再根据主键ID去查询保存的数据，进行其他逻辑处理。后来发现，在服务B中根据MQ发送过来的ID通过数据库偶尔会查不到数据信息。</p><p>后来通过调试才发现，是因为在服务A里的保存方法加了事务注解，保存的数据结果只有在当前方法执行完成后才会对外生效，而MQ消息则是在保存方法执行前发送的，如果服务B在服务A中保存方法执行完成前就收到了MQ消息，就会导致上述问题发生。同样，如果在MQ发送成功后，保存方法发生了异常导致事务回滚，服务B也会查不到数据或者查询到错误的数据。</p><span id="more"></span><h1 id="问题分析"><a href="#问题分析" class="headerlink" title="问题分析"></a>问题分析</h1><p>导致上述问题发生的根本原因还是因为发送MQ消息是在加了事务回滚的方法内部执行的，通过该方法保存或更新的数据只有在整个方法结束后才会对外生效，而MQ的消费者却有可能于改方法执行完成前收到消息。因此，最直接的解决办法是要将MQ消息放到事务方法结束后再执行。</p><p>但是，由于在项目中有很多处都是采用上述的这种逻辑，一个个改起来比较麻烦，最好能有一个通用的方式能够尽量少改动之前的业务逻辑代码就能解决问题。</p><h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>对于这种通用业务的问题第一个想到的解决方法就是利用AOP：拦截所有带有事务回滚注解(<code>@Transactional</code>)的方法，通过某种方式获取到该方法内部所有要执行的发送MQ的调用代码，让它们在事务方法执行成功后在执行。</p><h2 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h2><p><code>TransactionMessageAspect</code>继承<code>TransactionSynchronizationAdapter</code>,实现对所有带有<code>@Transactional</code>注解方法的拦截：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionMessageAspect</span> <span class="keyword">extends</span> <span class="title">TransactionSynchronizationAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TransactionInterceptorHandler transactionInterceptorHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 入口：拦截带有 <span class="doctag">@Transactional</span>的方法,标记当前方法已进入事务模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Before(&quot;@annotation(org.springframework.transaction.annotation.Transactional)&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerTransactionSyncrhonization</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        TransactionSynchronizationManager.registerSynchronization(<span class="keyword">this</span>);</span><br><span class="line">        transactionInterceptorHandler.signInTransaction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeCommit</span><span class="params">(<span class="keyword">boolean</span> readOnly)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;before commit&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 在事务结束并且没被回滚时再依次执行Callable方法</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> status</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(<span class="keyword">int</span> status)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCompletion&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (status != STATUS_ROLLED_BACK &amp;&amp; !CollectionUtils.isEmpty(transactionInterceptorHandler.getActions())) &#123;</span><br><span class="line">                <span class="keyword">for</span> (Callable action : transactionInterceptorHandler.getActions()) &#123;</span><br><span class="line">                    action.call();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            transactionInterceptorHandler.clear();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCommit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;afterCommit&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">suspend</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;suspend&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resume</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;resume&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;flush&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">beforeCompletion</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;beforeCompletion&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TransactionInterceptorHandler</code>:使用<code>ThreadLocal</code>对当前线程中要执行的发送MQ方法进行缓存</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionInterceptorHandler</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ThreadLocal&lt;Entity&gt; cache = ThreadLocal.withInitial(() -&gt; <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">clear</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        cache.remove();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Entity e = cache.get();</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> e.getInTransaction() != <span class="keyword">null</span> &amp;&amp; e.getInTransaction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Callable&gt; <span class="title">getActions</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Entity e = cache.get();</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> e.getActions();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">signInTransaction</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Entity e= cache.get();</span><br><span class="line">        <span class="keyword">if</span> (e == <span class="keyword">null</span>) &#123;</span><br><span class="line">            e = <span class="keyword">new</span> Entity();</span><br><span class="line">            e.setInTransaction(<span class="keyword">true</span>);</span><br><span class="line">            e.setActions(<span class="keyword">new</span> ArrayList&lt;&gt;());</span><br><span class="line">        &#125;</span><br><span class="line">        cache.set(e);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAction</span><span class="params">(Callable action)</span> </span>&#123;</span><br><span class="line">        Entity e = cache.get();</span><br><span class="line">        e.getActions().add(action);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Entity</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> List&lt;Callable&gt; actions;</span><br><span class="line">        <span class="keyword">private</span> Boolean inTransaction;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MqMessage: 发送MQ消息的封装类</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqMessage</span> <span class="keyword">implements</span> <span class="title">BaseMessage</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TransactionInterceptorHandler transactionInterceptorHandler;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Object message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[&quot;</span> + LocalDateTime.now() + <span class="string">&quot;] sendMsg :&quot;</span> + JSON.toJSONString(message));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将其更改为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MqMessage</span> <span class="keyword">implements</span> <span class="title">BaseMessage</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> TransactionInterceptorHandler transactionInterceptorHandler;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Object message)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (transactionInterceptorHandler.hasTransaction()) &#123;</span><br><span class="line">            Callable&lt;Object&gt; callable = () -&gt; doSendMessage(message);</span><br><span class="line">            transactionInterceptorHandler.addAction(callable);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            doSendMessage(message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Object <span class="title">doSendMessage</span><span class="params">(Object message)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;[&quot;</span> + LocalDateTime.now() + <span class="string">&quot;] sendMsg :&quot;</span> + JSON.toJSONString(message));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><ol><li><code>TransactionMessageAspect</code>会拦截带有<code>@Transactional</code>注解的方法，使用<code>TransactionInterceptorHandler.signInTransaction()</code>标记当前方法已进入事务模式;</li><li>如果在执行事务方法的过程中，有调用<code>MqMessage.sendMessage()</code>方法进行传递，会先将要发送的消息逻辑封装到<code>Callable</code>中，并通过<code>TransactionInterceptorHandler.addAction</code>保存在本地线程中；</li><li>当事务提交成功并没有回滚后再通过<code>TransactionMessageAspect.afterCompletion()</code>方法执行保存在本地线程中要发送MQ的调用方法；</li></ol><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://stackoverflow.com/questions/23651464/spring-hibernate-how-to-call-some-method-after-transaction-commit-or-transacti/23653651">Spring hibernate , how to call some method after transaction commit or transaction rollback</a></li><li><a href="https://stackoverflow.com/questions/15026142/creating-a-post-commit-when-using-transaction-in-spring">Creating a post commit when using transaction in Spring</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;问题描述&quot;&gt;&lt;a href=&quot;#问题描述&quot; class=&quot;headerlink&quot; title=&quot;问题描述&quot;&gt;&lt;/a&gt;问题描述&lt;/h1&gt;&lt;p&gt;之前遇到过一个这样的问题：在服务A里的执行一个保存数据库方法，数据保存成功后会将主键ID通过MQ发送给服务B,服务B再根据主键ID去查询保存的数据，进行其他逻辑处理。后来发现，在服务B中根据MQ发送过来的ID通过数据库偶尔会查不到数据信息。&lt;/p&gt;
&lt;p&gt;后来通过调试才发现，是因为在服务A里的保存方法加了事务注解，保存的数据结果只有在当前方法执行完成后才会对外生效，而MQ消息则是在保存方法执行前发送的，如果服务B在服务A中保存方法执行完成前就收到了MQ消息，就会导致上述问题发生。同样，如果在MQ发送成功后，保存方法发生了异常导致事务回滚，服务B也会查不到数据或者查询到错误的数据。&lt;/p&gt;
    
    </summary>
    
      <category term="Spring" scheme="https://www.wangfeng.pro/categories/Spring/"/>
    
    
      <category term="Aop" scheme="https://www.wangfeng.pro/tags/Aop/"/>
    
      <category term="ThreadLocal" scheme="https://www.wangfeng.pro/tags/ThreadLocal/"/>
    
      <category term="Transactional" scheme="https://www.wangfeng.pro/tags/Transactional/"/>
    
  </entry>
  
  <entry>
    <title>wakatime手动同步本地离线数据至服务器</title>
    <link href="https://www.wangfeng.pro/2019/10/wakatime%E6%89%8B%E5%8A%A8%E5%90%8C%E6%AD%A5%E6%9C%AC%E5%9C%B0%E7%A6%BB%E7%BA%BF%E6%95%B0%E6%8D%AE%E8%87%B3%E6%9C%8D%E5%8A%A1%E5%99%A8.html"/>
    <id>https://www.wangfeng.pro/2019/10/wakatime手动同步本地离线数据至服务器.html</id>
    <published>2019-10-20T05:40:33.000Z</published>
    <updated>2021-05-14T11:59:44.321Z</updated>
    
    <content type="html"><![CDATA[<ol><li>控制台执行</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo pip install --upgrade wakatime</span><br></pre></td></tr></table></figure><span id="more"></span><ol start="2"><li>同步本地的9999条heartbeat数据至服务器</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wakatime --sync-offline-activity 9999</span><br></pre></td></tr></table></figure><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://github.com/wakatime/wakatime/issues/157">How can i force sync all my coding activity?</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;ol&gt;
&lt;li&gt;控制台执行&lt;/li&gt;
&lt;/ol&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;sudo pip install --upgrade wakatime&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="其它" scheme="https://www.wangfeng.pro/categories/%E5%85%B6%E5%AE%83/"/>
    
    
      <category term="WakaTime" scheme="https://www.wangfeng.pro/tags/WakaTime/"/>
    
  </entry>
  
  <entry>
    <title>ssh快捷登录并执行命令</title>
    <link href="https://www.wangfeng.pro/2019/09/ssh%E5%BF%AB%E6%8D%B7%E7%99%BB%E5%BD%95%E5%B9%B6%E6%89%A7%E8%A1%8C%E5%91%BD%E4%BB%A4.html"/>
    <id>https://www.wangfeng.pro/2019/09/ssh快捷登录并执行命令.html</id>
    <published>2019-09-30T07:36:15.000Z</published>
    <updated>2021-04-29T12:06:54.512Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>公司有很多测试服务器，经常需要登录这些服务器测试来查看服务日志。由于这些测试服务器只能通过账号+密码的方式登录，Windows下可以通过Xshell实现自动登录，但在MacOS中并没有发现比较好的工具，<br>在终端通过SSH方式登录时每次都需要输入密码，十分麻烦，经过一番搜索，最终实现了使用<code>expect</code>在终端直接ssh自动登录,并在登录成功后执行指定脚本。</p></blockquote><span id="more"></span><h1 id="安装expect"><a href="#安装expect" class="headerlink" title="安装expect"></a>安装expect</h1><h2 id="MacOS"><a href="#MacOS" class="headerlink" title="MacOS:"></a>MacOS:</h2><p>直接通过<a href="https://brew.sh/index_zh-cn">Homebrew</a>来安装：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install expect</span><br></pre></td></tr></table></figure><h2 id="Linux系统"><a href="#Linux系统" class="headerlink" title="Linux系统"></a>Linux系统</h2><p>请自行搜索</p><h1 id="编写脚本"><a href="#编写脚本" class="headerlink" title="编写脚本"></a>编写脚本</h1><p>在<code>/usr/local/bin</code>目录下新建脚本<code>auth_ssh.sh</code>和<code>do_ssh.sh</code>：</p><h2 id="auto-ssh-sh"><a href="#auto-ssh-sh" class="headerlink" title="auto_ssh.sh"></a>auto_ssh.sh</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">host=<span class="variable">$1</span></span><br><span class="line">port=<span class="variable">$2</span></span><br><span class="line">user=<span class="variable">$3</span></span><br><span class="line">pswd=<span class="variable">$4</span></span><br><span class="line">cmd=<span class="variable">$5</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$cmd</span>&quot;</span> ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    cmd = <span class="string">&quot;cd ~/&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">do_ssh.sh <span class="variable">$host</span> <span class="variable">$port</span> <span class="variable">$user</span> <span class="variable">$pswd</span> <span class="string">&quot;<span class="variable">$cmd</span>&quot;</span></span><br></pre></td></tr></table></figure><h2 id="do-ssh-sh"><a href="#do-ssh-sh" class="headerlink" title="do_ssh.sh"></a>do_ssh.sh</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> timeout 30</span><br><span class="line"><span class="built_in">set</span> host [lindex <span class="variable">$argv</span> 0]</span><br><span class="line"><span class="built_in">set</span> port [lindex <span class="variable">$argv</span> 1]</span><br><span class="line"><span class="built_in">set</span> user [lindex <span class="variable">$argv</span> 2]</span><br><span class="line"><span class="built_in">set</span> pswd [lindex <span class="variable">$argv</span> 3]</span><br><span class="line"><span class="built_in">set</span> cmd [lindex <span class="variable">$argv</span> 4]</span><br><span class="line"></span><br><span class="line">spawn ssh -p <span class="variable">$port</span> <span class="variable">$user</span>@<span class="variable">$host</span></span><br><span class="line">expect &#123;</span><br><span class="line">        <span class="string">&quot;(yes/no)?&quot;</span></span><br><span class="line">        &#123;send <span class="string">&quot;yes\n&quot;</span>;exp_continue&#125;</span><br><span class="line">        <span class="string">&quot;password:&quot;</span></span><br><span class="line">        &#123;send <span class="string">&quot;<span class="variable">$pswd</span>\n&quot;</span>&#125;</span><br><span class="line">        <span class="string">&quot;Password:&quot;</span></span><br><span class="line">        &#123;send <span class="string">&quot;<span class="variable">$pswd</span>\n&quot;</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line">expect  &#123;</span><br><span class="line">    <span class="string">&quot;login&quot;</span></span><br><span class="line">    &#123;send <span class="string">&quot;<span class="variable">$cmd</span>\n&quot;</span>&#125;</span><br><span class="line">&#125; </span><br><span class="line">interact</span><br></pre></td></tr></table></figure><p>注意：第20行的<code>login</code>表示期待登录成功后的输出会包含字符串<code>login</code>，请根据实际情况做修改</p><p>之后在终端执行命令 <code>auto_ssh &lt;host&gt; &lt;port&gt; &lt;user&gt; &lt;pswd&gt; &quot;&lt;cmd&gt;&quot;</code>即可。</p><h1 id="为登录命令配置别名"><a href="#为登录命令配置别名" class="headerlink" title="为登录命令配置别名"></a>为登录命令配置别名</h1><p>在<code>~/.bash_profile</code>添加命令别名,例如:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alias</span> ss76=<span class="string">&quot;auto_ssh.sh 192.168.12.76 22 root abcd \&quot;cd /home/tomcat/\&quot;&quot;</span></span><br></pre></td></tr></table></figure><p>然后执行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> ~/.bash_profile</span><br></pre></td></tr></table></figure><p>之后在终端<code>ss76</code>即可自动登录到<code>192.168.12.76</code>并切换到<code>/home/tomcat/</code>目录中</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://adolphor.com/blog/2017/06/26/iterm2-expect-auto-ssh-login.html">iterm2 配合 expect 实现 SSH 自动登陆</a></li><li><a href="http://zyy1217.com/2017/07/02/linux%20expect%E8%AF%A6%E8%A7%A3/">linux expect详解(ssh自动登录，部署)</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;公司有很多测试服务器，经常需要登录这些服务器测试来查看服务日志。由于这些测试服务器只能通过账号+密码的方式登录，Windows下可以通过Xshell实现自动登录，但在MacOS中并没有发现比较好的工具，&lt;br&gt;在终端通过SSH方式登录时每次都需要输入密码，十分麻烦，经过一番搜索，最终实现了使用&lt;code&gt;expect&lt;/code&gt;在终端直接ssh自动登录,并在登录成功后执行指定脚本。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Linux" scheme="https://www.wangfeng.pro/categories/Linux/"/>
    
    
      <category term="ssh" scheme="https://www.wangfeng.pro/tags/ssh/"/>
    
  </entry>
  
  <entry>
    <title>Mac中在升级ruby版本后colorls命令报错的解决办法</title>
    <link href="https://www.wangfeng.pro/2019/09/mac%E4%B8%AD%E5%9C%A8%E5%8D%87%E7%BA%A7ruby%E7%89%88%E6%9C%AC%E5%90%8Ecolorls%E5%91%BD%E4%BB%A4%E6%8A%A5%E9%94%99%E7%9A%84%E8%A7%A3%E5%86%B3%E5%8A%9E%E6%B3%95.html"/>
    <id>https://www.wangfeng.pro/2019/09/mac中在升级ruby版本后colorls命令报错的解决办法.html</id>
    <published>2019-09-25T13:33:53.000Z</published>
    <updated>2021-04-29T12:04:57.376Z</updated>
    
    <content type="html"><![CDATA[<h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>为了在mac中使用tmuxinator，按照网上的教程使用rvm升级了系统的ruby版本，ruby升级完成后却发现执行colorls相关命令时，报了如下错误：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/dependency.rb:319:<span class="keyword">in</span> `to_specs<span class="string">&#x27;: Could not find &#x27;</span>clocale<span class="string">&#x27; (&gt;= 0) among 20 total gem(s) (Gem::LoadError)</span></span><br><span class="line"><span class="string">Checked in &#x27;</span>GEM_PATH=/Users/em/.gem/ruby/2.3.0:/Library/Ruby/Gems/2.3.0:/System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/gems/2.3.0<span class="string">&#x27;, execute `gem env` for more information</span></span><br><span class="line"><span class="string">from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/specification.rb:1442:in `block in activate_dependencies&#x27;</span></span><br><span class="line">from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/specification.rb:1431:<span class="keyword">in</span> `each<span class="string">&#x27;</span></span><br><span class="line"><span class="string">from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/specification.rb:1431:in `activate_dependencies&#x27;</span></span><br><span class="line">from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/specification.rb:1413:<span class="keyword">in</span> `activate<span class="string">&#x27;</span></span><br><span class="line"><span class="string">from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems.rb:196:in `rescue in try_activate&#x27;</span></span><br><span class="line">from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems.rb:193:<span class="keyword">in</span> `try_activate<span class="string">&#x27;</span></span><br><span class="line"><span class="string">from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/core_ext/kernel_require.rb:125:in `rescue in require&#x27;</span></span><br><span class="line">from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/core_ext/kernel_require.rb:39:<span class="keyword">in</span> `require<span class="string">&#x27;</span></span><br><span class="line"><span class="string">from /Library/Ruby/Gems/2.3.0/gems/colorls-1.1.1/exe/colorls:3:in `&lt;top (required)&gt;&#x27;</span></span><br><span class="line">from /usr/<span class="built_in">local</span>/bin/colorls:22:<span class="keyword">in</span> `load<span class="string">&#x27;</span></span><br><span class="line"><span class="string">from /usr/local/bin/colorls:22:in `&lt;main&gt;&#x27;</span></span><br></pre></td></tr></table></figure><span id="more"></span><h1 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a>解决办法</h1><p>在终端执行以下命令：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">xcode-select --install</span><br><span class="line">brew install rbenv</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PATH=&quot;/usr/local/opt/openssl/bin:$PATH&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export LDFLAGS=&quot;-L/usr/local/opt/openssl/lib&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export CPPFLAGS=&quot;-I/usr/local/opt/openssl/include&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;export PKG_CONFIG_PATH=&quot;/usr/local/opt/openssl/lib/pkgconfig&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line">sudo gem pristine --all <span class="comment">#that produced a permissions error, but i don&#x27;t care everything worked</span></span><br><span class="line">sudo gem install colorls</span><br></pre></td></tr></table></figure><p>如果执行<code>xcode-select --install</code>时提示</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-select: error: <span class="built_in">command</span> line tools are already installed, use <span class="string">&quot;Software Update&quot;</span> to install updates</span><br></pre></td></tr></table></figure><p>可以忽略。</p><h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol><li><a href="https://github.com/avdv/clocale/issues/22">https://github.com/avdv/clocale/issues/22</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;问题&quot;&gt;&lt;a href=&quot;#问题&quot; class=&quot;headerlink&quot; title=&quot;问题&quot;&gt;&lt;/a&gt;问题&lt;/h1&gt;&lt;p&gt;为了在mac中使用tmuxinator，按照网上的教程使用rvm升级了系统的ruby版本，ruby升级完成后却发现执行colorls相关命令时，报了如下错误：&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/dependency.rb:319:&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; `to_specs&lt;span class=&quot;string&quot;&gt;&amp;#x27;: Could not find &amp;#x27;&lt;/span&gt;clocale&lt;span class=&quot;string&quot;&gt;&amp;#x27; (&amp;gt;= 0) among 20 total gem(s) (Gem::LoadError)&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;Checked in &amp;#x27;&lt;/span&gt;GEM_PATH=/Users/em/.gem/ruby/2.3.0:/Library/Ruby/Gems/2.3.0:/System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/gems/2.3.0&lt;span class=&quot;string&quot;&gt;&amp;#x27;, execute `gem env` for more information&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;	from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/specification.rb:1442:in `block in activate_dependencies&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/specification.rb:1431:&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; `each&lt;span class=&quot;string&quot;&gt;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;	from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/specification.rb:1431:in `activate_dependencies&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/specification.rb:1413:&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; `activate&lt;span class=&quot;string&quot;&gt;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;	from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems.rb:196:in `rescue in try_activate&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems.rb:193:&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; `try_activate&lt;span class=&quot;string&quot;&gt;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;	from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/core_ext/kernel_require.rb:125:in `rescue in require&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	from /System/Library/Frameworks/Ruby.framework/Versions/2.3/usr/lib/ruby/2.3.0/rubygems/core_ext/kernel_require.rb:39:&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; `require&lt;span class=&quot;string&quot;&gt;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;	from /Library/Ruby/Gems/2.3.0/gems/colorls-1.1.1/exe/colorls:3:in `&amp;lt;top (required)&amp;gt;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;	from /usr/&lt;span class=&quot;built_in&quot;&gt;local&lt;/span&gt;/bin/colorls:22:&lt;span class=&quot;keyword&quot;&gt;in&lt;/span&gt; `load&lt;span class=&quot;string&quot;&gt;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;string&quot;&gt;	from /usr/local/bin/colorls:22:in `&amp;lt;main&amp;gt;&amp;#x27;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="其它" scheme="https://www.wangfeng.pro/categories/%E5%85%B6%E5%AE%83/"/>
    
      <category term="Mac" scheme="https://www.wangfeng.pro/categories/%E5%85%B6%E5%AE%83/Mac/"/>
    
    
      <category term="colorls" scheme="https://www.wangfeng.pro/tags/colorls/"/>
    
      <category term="gem" scheme="https://www.wangfeng.pro/tags/gem/"/>
    
  </entry>
  
  <entry>
    <title>彻底搞懂字符串比较问题和String.intern()方法的作用</title>
    <link href="https://www.wangfeng.pro/2019/01/%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%AF%94%E8%BE%83%E9%97%AE%E9%A2%98%E5%92%8Cstring-intern-%E6%96%B9%E6%B3%95%E7%9A%84%E4%BD%9C%E7%94%A8.html"/>
    <id>https://www.wangfeng.pro/2019/01/彻底搞懂字符串比较问题和string-intern-方法的作用.html</id>
    <published>2019-01-30T09:55:56.000Z</published>
    <updated>2021-05-14T13:06:17.483Z</updated>
    
    <content type="html"><![CDATA[<blockquote><p>网上看面试题时经常看到各种字符串比较的问题，有时看着答案也不知道为什么。于是今天花了一点时间对此做了一下深入的学习，在此记录一下。</p></blockquote><span id="more"></span><h2 id="创建字符串时需要注意的规则"><a href="#创建字符串时需要注意的规则" class="headerlink" title="创建字符串时需要注意的规则"></a>创建字符串时需要注意的规则</h2><p>这里列的规则是我结合JDK里的文档和《<a href="https://www.cnblogs.com/Kidezyq/p/8040338.html">Java-String.intern的深入研究</a>》、《<a href="https://blog.csdn.net/soonfly/article/details/70147205">几张图轻松理解String.intern()</a>》这两篇文章，对于理解下面的实例中我认为比较关键的几点，可能有些理解不正确。</p><p>1、通过<code>new String(String original)</code>会有涉及到两个对象。<br>例如 <code>String str = new String(&quot;a&quot;)</code>语句,会先将构造函数里的参数<code>original</code>指向在字符串常量池(简称SCP),如果常量池中不存在，则会在常量池中生成字符串<strong>a</strong>，再在堆(HEAP)中生成变量<code>str</code>;</p><p>2、如果一个字符串<code>str</code>是由多个常量字符串通过**+**拼接的，则字符串<code>str</code>会直接生成或指向在字符串常量池中。</p><p>情况一：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">String str = <span class="string">&quot;a&quot;</span> + <span class="string">&quot;b&quot;</span>;</span><br></pre></td></tr></table></figure><p>情况二：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">String str = <span class="string">&quot;a&quot;</span> + b;</span><br></pre></td></tr></table></figure><p>情况三：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">String str = <span class="string">&quot;a&quot;</span> + b;</span><br></pre></td></tr></table></figure><p>在上面的三种情况中，第一种和第三种情况的<code>str</code>都是由常量字符串直接拼接的，所以<code>str</code>会直接指向字符串常量池；而情况二中由于存在局部变量<code>b</code>,编译器将会通过<code>StringBuilder.append()</code>方法拼接字符串<code>a</code>和变量<code>b</code>后，最终再通过<code>StringBuilder.toString()</code>方法得到<code>str</code>，<code>str</code>会在堆中生成。</p><p>3、JDK 1.7后，在执行 <code>String.intern()</code>方法时，虚拟机会去字符串常量池检查是否已存在该字符串，如果存在则会直接引用常量池中该字符串的地址作为返回结果的引用地址；如果不存在，则会在常量池中生成一个对在原字符串(位于堆中)的引用作为，而不是像 JDK 1.6之前仍将原字符串拷贝到常量池中。</p><h2 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h2><h3 id="实例1"><a href="#实例1" class="headerlink" title="实例1"></a>实例1</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;    <span class="comment">//SCP</span></span><br><span class="line">    String i = <span class="string">&quot;a&quot;</span> + <span class="string">&quot;b&quot;</span>; <span class="comment">//SCP</span></span><br><span class="line">    String j = i.intern();  <span class="comment">//SCP</span></span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(c == j);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>String c = &quot;ab&quot;</code>将直接在字符串常量池生成字符串<strong>ab</strong>；由于<code>i</code>是由两个字符串常量<strong>a</strong>和<strong>b</strong>直接拼接而成，所以<code>i</code>也会指向字符串常量池；由于<code>i.intern()</code>得到的字符串在常量池中已存在，所以<code>j</code>也指向常量池。因此<code>c</code>、<code>i</code>、<code>j</code>指向的同一个地址。因此输出结果为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="实例2"><a href="#实例2" class="headerlink" title="实例2"></a>实例2</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;    <span class="comment">//SCP</span></span><br><span class="line">    String i = <span class="keyword">new</span> String(<span class="string">&quot;a&quot;</span>) + <span class="keyword">new</span> String(<span class="string">&quot;b&quot;</span>); <span class="comment">//HEAP</span></span><br><span class="line">    String j = i.intern();  <span class="comment">//SCP</span></span><br><span class="line">    System.out.println(c == i);</span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(c == j);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>String i = new String(&quot;a&quot;) + new String(&quot;b&quot;);</code>语句会在字符串常量池中生成两个字符串<strong>a</strong>和<strong>b</strong>,在堆中生成3个对象：两个是由<code>new String()</code>生成的，另外一个是<code>i</code>。结合<a href="#%E5%AE%9E%E4%BE%8B1">实例1</a>的说明，可知：<code>c</code>和<code>j</code>指向字符串常量池中指向地址，而<code>i</code>指向堆中。因此输出结果为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="实例3"><a href="#实例3" class="headerlink" title="实例3"></a>实例3</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;    <span class="comment">//SCP</span></span><br><span class="line">    String i = <span class="keyword">new</span> String(<span class="string">&quot;ab&quot;</span>); <span class="comment">//HEAP</span></span><br><span class="line">    String j = i.intern();  <span class="comment">//SCP</span></span><br><span class="line">    System.out.println(c == i);</span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(c == j);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>和<a href="#%E5%AE%9E%E4%BE%8B2">实例2</a>中类似，<code>String i = new String(&quot;ab&quot;);</code>语句中构造函数里的字符串<strong>ab</strong>会直接指向由<code>String c = &quot;ab&quot;;</code>语句在字符串常量池中生成的字符串的地址，在堆中生成一个字符串对象<code>i</code>。所以输出结果和<a href="#%E5%AE%9E%E4%BE%8B2">实例2</a>一样：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="实例4"><a href="#实例4" class="headerlink" title="实例4"></a>实例4</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;    <span class="comment">//SCP</span></span><br><span class="line">    String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    String i = <span class="string">&quot;a&quot;</span> + b; <span class="comment">//HEAP</span></span><br><span class="line">    String j = i.intern();  <span class="comment">//SCP</span></span><br><span class="line">    System.out.println(c == i);</span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(c == j);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>根据本文开头的第2点规则，可知<code>String i = &quot;a&quot; + b;</code>语句中生成的变量<code>i</code>是位于堆中的，而<code>c</code>和<code>j</code>都指向字符串常量池。因此输出结果为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="实例5"><a href="#实例5" class="headerlink" title="实例5"></a>实例5</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    String i = <span class="string">&quot;a&quot;</span> + b; <span class="comment">//HEAP</span></span><br><span class="line">    String j = i.intern();  <span class="comment">//SCP -&gt; HEAP</span></span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;    <span class="comment">//SCP -&gt; HEAP</span></span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(c == j);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与<a href="#%E5%AE%9E%E4%BE%8B4">实例4</a>中不同的是，虽然<code>i</code>是位于堆中，但是在执行<code>String j = i.intern()</code>时，由于字符串常量池中不存在字符串<strong>ab</strong>，根据本文开头的第3点规则，此时并不会直接把字符串<strong>ab</strong>复制在字符串常量池中，而是在常量池中为字符串<strong>ab</strong>生成指向堆中对象<strong>i</strong>的引用，包括之后的语句<code>String c = &quot;ab&quot;;</code>中<code>c</code>指向的也是常量池中指向堆中对象<strong>i</strong>的引用，所有<code>c</code>、<code>i</code>、<code>j</code>指向的实际是同一个地址。因此输出结果为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="实例6"><a href="#实例6" class="headerlink" title="实例6"></a>实例6</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String i = <span class="keyword">new</span> String(<span class="string">&quot;ab&quot;</span>); <span class="comment">//HEAP</span></span><br><span class="line">    String j = i.intern();  <span class="comment">//SCP</span></span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;    <span class="comment">//SCP</span></span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(c == j);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>如果不仔细思考，可能会认为输出结果应该和<a href="#%E5%AE%9E%E4%BE%8B5">实例5</a>一样，但实际的输出结果却是如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><p>参考<a href="#%E5%AE%9E%E4%BE%8B3">实例3</a>，想清楚<code>String i = new String(&quot;ab&quot;);</code>是会先在字符串常量池生成字符串<strong>ab</strong>这一点后，就很容易知道和<a href="#%E5%AE%9E%E4%BE%8B5">实例5</a>的区别了。</p><h3 id="实例7"><a href="#实例7" class="headerlink" title="实例7"></a>实例7</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test7</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    String i = <span class="string">&quot;a&quot;</span> + b; <span class="comment">//SCP</span></span><br><span class="line">    String j = i.intern();  <span class="comment">//SCP</span></span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;    <span class="comment">//SCP</span></span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(c == j);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>与<a href="#%E5%AE%9E%E4%BE%8B5">实例5</a>的区别在于对象<code>b</code>是用<code>final</code>修饰的，可以看做局部常量，字符串对象<code>i</code>是由两个字符串常量通过<code>+</code>直接拼接而成，<code>i</code>将指向字符串常量池。因此输出结果为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="实例8"><a href="#实例8" class="headerlink" title="实例8"></a>实例8</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test8</span><span class="params">(<span class="keyword">final</span> String b)</span> </span>&#123;</span><br><span class="line">    String i = <span class="string">&quot;a&quot;</span> + b; <span class="comment">//HEAP</span></span><br><span class="line">    String j = i.intern();  <span class="comment">//SCP -&gt; HEAP</span></span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;    <span class="comment">//SCP -&gt; HEAP</span></span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(c == j);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test8</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    test8(b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这个实例的结果和<a href="#%E5%AE%9E%E4%BE%8B7">实例7</a>一样：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><p>但是含义不同，虽然在方法<code>test8(final String b)</code>中，形参<code>b</code>是用<code>final</code>修饰的，但<code>b</code>的值仍然是外部传来的，所以不能看做字符串常量。因此<code>i</code>是执行堆中的对象，而<code>j</code>和<code>c</code>是因为执行<code>i.intern()</code>之后，间接通过常量池指向了和<code>i</code>同一个地址。<br>调换一下上述方法中语句的位置，也可以验证改实例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">test8_1</span><span class="params">(<span class="keyword">final</span> String b)</span> </span>&#123;</span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;    <span class="comment">//SCP</span></span><br><span class="line">    String i = <span class="string">&quot;a&quot;</span> + b; <span class="comment">//HEAP</span></span><br><span class="line">    String j = i.intern();  <span class="comment">//SCP</span></span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(c == j);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test8_1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    test8_1(b);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>将<code>String c = &quot;ab&quot;; </code>语句提至方法内第一行后，在执行<code>i.intern()</code>时，由于常量池中已存在字符串<strong>ab</strong>，因此<code>j</code>将直接指向常量池中字符串<strong>ab</strong>的地址，而<code>i</code>是位于堆中的对象，所以输出结果为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><h3 id="实例9"><a href="#实例9" class="headerlink" title="实例9"></a>实例9</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test9</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    String b = <span class="string">&quot;b&quot;</span>;</span><br><span class="line">    String i = <span class="string">&quot;a&quot;</span> + b; <span class="comment">//HEAP_1</span></span><br><span class="line">    String l = <span class="string">&quot;a&quot;</span> + b; <span class="comment">//HEAP_2</span></span><br><span class="line">    String j = l.intern();  <span class="comment">//SCP -&gt; HEAP_2</span></span><br><span class="line">    String c = <span class="string">&quot;ab&quot;</span>;     <span class="comment">//SCP -&gt; HEAP_2</span></span><br><span class="line">    System.out.println(i.equals(j));</span><br><span class="line">    System.out.println(i == j);</span><br><span class="line">    System.out.println(l == j);</span><br><span class="line">    System.out.println(l == c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>结合前面的例子可知，<code>i</code>和<code>j</code>是位于堆中两个独立的对象。由于有<code>l.intern()</code>操作，<code>j</code>、<code>c</code>和<code>l</code>最终都指向了同一个地址。因此输出结果为：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">false</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line"><span class="literal">true</span></span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol><li><a href="https://www.cnblogs.com/Kidezyq/p/8040338.html">https://www.cnblogs.com/Kidezyq/p/8040338.html</a></li><li><a href="https://blog.csdn.net/soonfly/article/details/70147205">https://blog.csdn.net/soonfly/article/details/70147205</a></li><li><a href="https://www.geeksforgeeks.org/interning-of-string/">https://www.geeksforgeeks.org/interning-of-string/</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      &lt;blockquote&gt;
&lt;p&gt;网上看面试题时经常看到各种字符串比较的问题，有时看着答案也不知道为什么。于是今天花了一点时间对此做了一下深入的学习，在此记录一下。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="Java基础" scheme="https://www.wangfeng.pro/categories/Java/Java%E5%9F%BA%E7%A1%80/"/>
    
    
      <category term="Java" scheme="https://www.wangfeng.pro/tags/Java/"/>
    
      <category term="String" scheme="https://www.wangfeng.pro/tags/String/"/>
    
  </entry>
  
  <entry>
    <title>使用正则表达式解析Nginx默认日志</title>
    <link href="https://www.wangfeng.pro/2019/01/%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E8%A7%A3%E6%9E%90nginx%E9%BB%98%E8%AE%A4%E6%97%A5%E5%BF%97.html"/>
    <id>https://www.wangfeng.pro/2019/01/使用正则表达式解析nginx默认日志.html</id>
    <published>2019-01-26T05:13:03.000Z</published>
    <updated>2021-05-14T13:06:17.478Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>想通过 Nginx 的 access.log 分析网站的访问情况，但是直接通过日志文件看不太直观，于是想通过代码把日志文件解析并保存数据库中，这样分析起来更方便。</p><h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>参考 <a href="https://blog.csdn.net/thlzjfefe/article/details/83349548">nginx日志解析：java正则解析</a> 这篇文章，通过使用正则表达式把日志文件中的各个参数解析出来即可。</p><p>比如，我的服务器上 Nginx 记录的日志格式如下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">203.208.60.89 - - [04/Jan/2019:16:06:38 +0800] <span class="string">&quot;GET /atom.xml HTTP/1.1&quot;</span> 200 273932 <span class="string">&quot;-&quot;</span> <span class="string">&quot;Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)&quot;</span></span><br></pre></td></tr></table></figure><p>对应的 Java 正则表达式就是：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(?&lt;ip&gt;\d+\.\d+\.\d+\.\d+)( - - \[)(?&lt;datetime&gt;[\s\S]+)(?&lt;t1&gt;\][\s<span class="string">&quot;]+)(?&lt;request&gt;[A-Z]+) (?&lt;url&gt;[\S]*) (?&lt;protocol&gt;[\S]+)[&quot;</span>] (?&lt;code&gt;\d+) (?&lt;sendbytes&gt;\d+) [<span class="string">&quot;](?&lt;refferer&gt;[\S]*)[&quot;</span>] [<span class="string">&quot;](?&lt;useragent&gt;[\S\s]+)[&quot;</span>]</span><br></pre></td></tr></table></figure><p>完整代码如下：</p><h3 id="LogEntity类用于保存解析后的日志信息"><a href="#LogEntity类用于保存解析后的日志信息" class="headerlink" title="LogEntity类用于保存解析后的日志信息"></a><code>LogEntity</code>类用于保存解析后的日志信息</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.*;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:wf2311@163.com&quot;&gt;wf2311&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019-01-25 19:37.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Table</span></span><br><span class="line"><span class="meta">@Entity(name = &quot;log&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主键ID</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端IP</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String ip;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime time;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求方式 GET/POST/PUT 等</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String request;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问的url地址</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String url;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * http协议</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String protocol;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求结果响应码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 请求访问的字节数量</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer sendByteSize;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问者访问渠道来源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String refferer;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问者的用户代理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String useAgent;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问者是不是爬虫或机器人</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isBot;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 访问的是不是静态资源文件，例如：css、js、图片等文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isResource;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前项目名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String project;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="NginxLogConverter类实现解析的具体逻辑"><a href="#NginxLogConverter类实现解析的具体逻辑" class="headerlink" title="NginxLogConverter类实现解析的具体逻辑"></a><code>NginxLogConverter</code>类实现解析的具体逻辑</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Path;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.time.LocalDateTime;</span><br><span class="line"><span class="keyword">import</span> java.time.format.DateTimeFormatter;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Locale;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> java.util.stream.Collectors;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> &lt;a href=&quot;mailto:wf2311@163.com&quot;&gt;wf2311&lt;/a&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2019-01-25 19:35.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NginxLogConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATTERN = <span class="string">&quot;(?&lt;ip&gt;\\d+\\.\\d+\\.\\d+\\.\\d+)( - - \\[)(?&lt;datetime&gt;[\\s\\S]+)(?&lt;t1&gt;\\][\\s\&quot;]+)(?&lt;request&gt;[A-Z]+) (?&lt;url&gt;[\\S]*) (?&lt;protocol&gt;[\\S]+)[\&quot;] (?&lt;code&gt;\\d+) (?&lt;sendbytes&gt;\\d+) [\&quot;](?&lt;refferer&gt;[\\S]*)[\&quot;] [\&quot;](?&lt;useragent&gt;[\\S\\s]+)[\&quot;]&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析转换逻辑</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text    单条的日志记录</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> project 项目名称</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 解析成功则返回具体的对象，解析失败返回&lt;code&gt;null&lt;/code&gt;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LogEntity <span class="title">parse</span><span class="params">(String text, String project)</span> </span>&#123;</span><br><span class="line">        Pattern r = Pattern.compile(PATTERN);</span><br><span class="line">        Matcher m = r.matcher(text);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> (m.find()) &#123;</span><br><span class="line">            LogEntity log = <span class="keyword">new</span> LogEntity();</span><br><span class="line">            log.setIp(m.group(<span class="string">&quot;ip&quot;</span>));</span><br><span class="line">            log.setProject(project);</span><br><span class="line">            String datetime = m.group(<span class="string">&quot;datetime&quot;</span>);</span><br><span class="line">            log.setTime(convertTime(datetime));</span><br><span class="line">            log.setRequest(m.group(<span class="string">&quot;request&quot;</span>));</span><br><span class="line">            log.setUrl(m.group(<span class="string">&quot;url&quot;</span>));</span><br><span class="line">            log.setProtocol(m.group(<span class="string">&quot;protocol&quot;</span>));</span><br><span class="line">            log.setCode(Integer.valueOf(m.group(<span class="string">&quot;code&quot;</span>)));</span><br><span class="line">            log.setSendByteSize(Integer.valueOf(m.group(<span class="string">&quot;sendbytes&quot;</span>)));</span><br><span class="line">            log.setRefferer(m.group(<span class="string">&quot;refferer&quot;</span>));</span><br><span class="line">            log.setUseAgent(m.group(<span class="string">&quot;useragent&quot;</span>));</span><br><span class="line">            log.setBot(isBot(log.getUseAgent()));</span><br><span class="line">            log.setResource(isResource(log.getUrl()));</span><br><span class="line">            <span class="keyword">return</span> log;</span><br><span class="line">        &#125;</span><br><span class="line">        log.error(String.format(<span class="string">&quot;%s 格式化错误&quot;</span>, text));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提取转换时间</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> s 格式化的时间文本：26/Jan/2019:06:51:27 +0800]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> LocalDateTime 时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> LocalDateTime <span class="title">convertTime</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        String t = s.substring(<span class="number">0</span>, s.indexOf(<span class="string">&quot; &quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> LocalDateTime.parse(t, DateTimeFormatter.ofPattern(<span class="string">&quot;dd/MMM/yyyy:HH:mm:ss&quot;</span>, Locale.ENGLISH));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过 userAgent 字段判断是不是爬虫或机器人的访问记录</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userAgent 访问者的用户代理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否是爬虫或机器人的访问记录</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isBot</span><span class="params">(String userAgent)</span> </span>&#123;</span><br><span class="line">        String t = userAgent.toLowerCase();</span><br><span class="line">        <span class="keyword">return</span> t.contains(<span class="string">&quot;bot&quot;</span>) || t.contains(<span class="string">&quot;spider&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过 url 字段判断访问的是不是静态资源文件</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> url 访问的url路径</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 访问的是否是静态资源文件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isResource</span><span class="params">(String url)</span> </span>&#123;</span><br><span class="line">        String t = url.toLowerCase();</span><br><span class="line">        <span class="keyword">return</span> t.contains(<span class="string">&quot;.js&quot;</span>)</span><br><span class="line">                || t.contains(<span class="string">&quot;.css&quot;</span>)</span><br><span class="line">                || t.contains(<span class="string">&quot;.png&quot;</span>)</span><br><span class="line">                || t.contains(<span class="string">&quot;.ico&quot;</span>)</span><br><span class="line">                || t.contains(<span class="string">&quot;.gif&quot;</span>)</span><br><span class="line">                || t.contains(<span class="string">&quot;.txt&quot;</span>)</span><br><span class="line">                || t.contains(<span class="string">&quot;.woff&quot;</span>)</span><br><span class="line">                || t.contains(<span class="string">&quot;.eot&quot;</span>)</span><br><span class="line">                || t.contains(<span class="string">&quot;.jpg&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    Path path = Paths.get(<span class="string">&quot;/xx/xxx/access.log&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        List&lt;String&gt; logs = Files.readAllLines(path);</span><br><span class="line">        List&lt;LogEntity&gt; list = logs.stream().map(s -&gt; parse(s, <span class="string">&quot;$&#123;projectName&#125;&quot;</span>)).collect(Collectors.toList());</span><br><span class="line">        System.out.println(list.size());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol><li><a href="https://blog.csdn.net/thlzjfefe/article/details/83349548">nginx日志解析：java正则解析</a></li></ol><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;想通过 Nginx 的 access.log 分析网站的访问情况，但是直接通过日志文件看不太直观，于是想通过代码把日志文件解析并保存数据库中
      
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="其他" scheme="https://www.wangfeng.pro/categories/Java/%E5%85%B6%E4%BB%96/"/>
    
    
      <category term="笔记" scheme="https://www.wangfeng.pro/tags/%E7%AC%94%E8%AE%B0/"/>
    
      <category term="Java" scheme="https://www.wangfeng.pro/tags/Java/"/>
    
      <category term="Nginx" scheme="https://www.wangfeng.pro/tags/Nginx/"/>
    
      <category term="正则表达式" scheme="https://www.wangfeng.pro/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Java虚拟机结构(二):内存结构概述</title>
    <link href="https://www.wangfeng.pro/2019/01/java%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BB%93%E6%9E%84-%E4%BA%8C-%E5%86%85%E5%AD%98%E7%BB%93%E6%9E%84%E6%A6%82%E8%BF%B0.html"/>
    <id>https://www.wangfeng.pro/2019/01/java虚拟机结构-二-内存结构概述.html</id>
    <published>2019-01-23T09:22:29.000Z</published>
    <updated>2019-01-23T10:15:22.487Z</updated>
    
    <content type="html"><![CDATA[<h2 id="运行时数据区"><a href="#运行时数据区" class="headerlink" title="运行时数据区"></a>运行时数据区</h2><p>Java 虚拟机在会将它所管理的内存划分成若干个不同的区域，作用各不相同。</p><h3 id="线程私有区"><a href="#线程私有区" class="headerlink" title="线程私有区"></a>线程私有区</h3><h4 id="PC寄存器"><a href="#PC寄存器" class="headerlink" title="PC寄存器"></a>PC寄存器</h4><p>PC 寄存器是一块较小的内存区域，属于线程私有。PC 寄存器用于保存当前线程中正在执行的字节码指令的地址：对于非原生方法，指向的是字节码指令的地址;对于原生方法，保存的是 undefined。</p><h4 id="Java虚拟机栈"><a href="#Java虚拟机栈" class="headerlink" title="Java虚拟机栈"></a>Java虚拟机栈</h4><p>Java 虚拟机栈也是属于线程私有，随线程同时创建，用于存储栈帧(Frame)。其内存既可以设置成固定大小，也可以根据计算动态扩展和收缩；使用的内存不需要保证是连续的。</p><p>Java 虚拟机栈可能会抛出以下异常：</p><ul><li><code>StackOverflowError</code>:线程请求分配的栈容量超过栈允许的最大值;</li><li><code>OutOfMemoryError</code>: 栈尝试扩展但无法申请到足够的内存或者创建新的线程时没有足够的内存；</li></ul><h4 id="本地方法栈"><a href="#本地方法栈" class="headerlink" title="本地方法栈"></a>本地方法栈</h4><p>本地方法栈与 Java 虚拟机栈的作用类似，主要用于支持 native 。如果虚拟机支持本地方法栈，在线程创建时按线程分配。</p><p>同 Java 虚拟机栈一样，本地方法栈有可能会抛出下异常：</p><ul><li><code>StackOverflowError</code>:线程请求分配的栈容量超过栈允许的最大值;</li><li><code>OutOfMemoryError</code>: 栈尝试扩展但无法申请到足够的内存或者创建新的线程时没有足够的内存；</li></ul><p><strong>HotSpot 虚拟机直接把本地方法栈和 Java 虚拟机栈合二为一。</strong></p><h4 id="栈帧"><a href="#栈帧" class="headerlink" title="栈帧"></a>栈帧</h4><p>栈帧是用来存储数据和部分过程结果的数据结构，<br>同时也用来处理动态链接、方法返回和异常分发。栈帧在线程内随着方法调用而创建、方法结束(包含抛出异常)而销毁。其存储空间由创建它的线程在虚拟机栈中分配。</p><p>每个栈帧都有自己的本地变量表、操作数栈和指向当前方法所属类的运行时常量池的引用，本地变量表和操作数栈的容量在编译期确定。</p><h4 id="本地变量表"><a href="#本地变量表" class="headerlink" title="本地变量表"></a>本地变量表</h4><p>本地变量表用于保存局部变量，位于栈帧中，长度由编译期决定。</p><p>在本地变量表中保存 boolean、byte、char、short、int、float、reference或returnAddress 类型的数据需一个局部变量；保存 long、double 类型的数据需两个连续的局部变量。在本地变量表中的变量使用索引来定位访问，第一个变量的索引为0；在实例方法中，本地变量表中索引为0的位置存储的是该实例方法所在对象的引用(this)。</p><h4 id="操作数栈"><a href="#操作数栈" class="headerlink" title="操作数栈"></a>操作数栈</h4><p>操作数栈是一个后进先出的栈，位于栈帧中，最大深度由编译期决定。</p><p>在任意时刻，操作数栈都有一个确定的深度，long、double类型会占用两个单位的深度，其他数据类型只占一个单位的深度。</p><h4 id="动态链接"><a href="#动态链接" class="headerlink" title="动态链接"></a>动态链接</h4><p>动态链接可以理解为栈帧内部指向当前方法所在类型的运行时常量池的引用。</p><h3 id="线程共享区"><a href="#线程共享区" class="headerlink" title="线程共享区"></a>线程共享区</h3><h4 id="Java堆"><a href="#Java堆" class="headerlink" title="Java堆"></a>Java堆</h4><p>Java 堆是供所有类实例和数组对象分配内存的共享区域。它在虚拟机启动时被创建，存储被自动内存管理系统(垃圾收集器)所管理的各种对象。Java 堆的容量既可以设置成固定大小，也可以根据计算动态扩展和收缩；使用的内存不需要保证是连续的。</p><p>当实际所需的堆超出了自动内存管理系统能提供的最大值，会抛出<code>OutOfMemoryError</code>异常。</p><h4 id="方法区"><a href="#方法区" class="headerlink" title="方法区"></a>方法区</h4><p>方法区存储了每一个类的结构信息：运行时常量池、字段和方法数据、构造函数和普通方法的字节码内容；还包含一些在类、实例、接口初始化时用到的特殊方法。方法区是堆的逻辑组成部分，但虚拟机可以在这个区域不实现垃圾回收和压缩。方法区的容量既可以设置成固定大小，也可以根据计算动态扩展和收缩；使用的内存不需要保证是连续的。</p><p>当方法区的内存不能满足内存分配请求，会抛出<code>OutOfMemoryError</code>异常。</p><h4 id="运行时常量池"><a href="#运行时常量池" class="headerlink" title="运行时常量池"></a>运行时常量池</h4><p>运行时常量池是class文件中每一个类或接口的常量池表的运行时表现形式。在方法区中分配，在加载类或接口到虚拟机后会被创建。</p><p>当创建接口或类构造运行时常量池所需的内存超过了方法区所能提供的最大值时，会抛出<code>OutOfMemoryError</code>异常。</p><h2 id="直接内存"><a href="#直接内存" class="headerlink" title="直接内存"></a>直接内存</h2><p>直接内存并不是虚拟机运行时数据区的一部分，也不是 Java 虚拟机规范字定义的内存区域。<br>在 JDK 1.4中新加入的 NIO 引入了一种基于通道(Channel)与缓冲区(Buffer)的 I/O 方式，它可以使用 Native 函数库直接分配堆外内存，然后通过一个存储在 Java 堆中的 DirectByteBuffer 对象作为这块内存的引用进行操作。这样能在一些场景中显著提高性能，因为避免了在 Java 堆 和 Native 堆中来回复制数据。</p><p>当动态扩展直接内存的大小导致各个内存区域总和大于本机的物理内存限制时，会抛出<code>OutOfMemoryError</code>异常。</p><h2 id="思维导图"><a href="#思维导图" class="headerlink" title="思维导图"></a>思维导图</h2><div class="post-svg-container">    <object type="image/svg+xml" data="https://file.wf2311.com/2019/01/23/Java虚拟机内存结构.svg"></object></div><link rel="stylesheet" href="/css/spoiler.css" type="text/css"><script src="/js/spoiler.js" type="text/javascript" async></script>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;运行时数据区&quot;&gt;&lt;a href=&quot;#运行时数据区&quot; class=&quot;headerlink&quot; title=&quot;运行时数据区&quot;&gt;&lt;/a&gt;运行时数据区&lt;/h2&gt;&lt;p&gt;Java 虚拟机在会将它所管理的内存划分成若干个不同的区域，作用各不相同。&lt;/p&gt;
&lt;h3 id=&quot;线程私有
      
    
    </summary>
    
      <category term="Java" scheme="https://www.wangfeng.pro/categories/Java/"/>
    
      <category term="JVM" scheme="https://www.wangfeng.pro/categories/Java/JVM/"/>
    
      <category term="从零学习JVM" scheme="https://www.wangfeng.pro/categories/Java/JVM/%E4%BB%8E%E9%9B%B6%E5%AD%A6%E4%B9%A0JVM/"/>
    
    
      <category term="JVM" scheme="https://www.wangfeng.pro/tags/JVM/"/>
    
      <category term="Java" scheme="https://www.wangfeng.pro/tags/Java/"/>
    
  </entry>
  
</feed>
